# Google OAuth/Supabase -> 자체 로컬 계정 시스템 전환 계획

**작성일:** 2026-02-25
**개정일:** 2026-02-25 (v2 -- Architect/Critic 리뷰 피드백 반영)
**범위:** 인증 시스템 전면 교체 (약 20개 파일 변경/생성)
**예상 복잡도:** MEDIUM-HIGH
**위험도:** HIGH (인증 시스템은 전체 앱의 게이트키퍼)
**컨센서스:** Architect CONDITIONAL APPROVE → Critic APPROVE (v2)

---

## 1. 컨텍스트

### 현재 상태
- Supabase OAuth를 통한 Google 로그인 (`supabase>=2.0.0` 패키지 의존)
- 인증 흐름: `/api/auth/google` -> Google -> `/api/auth/callback?code=...` -> Supabase 토큰 교환
- 세션: itsdangerous 서명 쿠키에 `access_token` + `refresh_token` 저장
- `LazyAuthMiddleware`가 매 요청마다 Supabase API로 토큰 검증 + 자동 리프레시
- `user_profiles` 테이블: id(UUID, Supabase user ID), email, display_name, role
- Supabase service client로 `user_profiles` upsert 및 role 조회
- DB 마이그레이션에 `is_admin()` SQL 함수가 `auth.uid()` (Supabase 전용) 참조

### 전환 목표
- 외부 인증 의존성(Supabase, Google OAuth) 완전 제거
- 관리자가 계정을 생성/할당하고, 사용자는 할당받은 이메일+비밀번호로 로그인
- 기존 세션 관리(itsdangerous), RBAC(user/admin), CSRF 보호 그대로 유지
- 관리자 기능 강화: 사용자 생성, 비밀번호 초기화
- brute-force 방어 및 계정 잠금 메커니즘 내장
- 비밀번호 정책 강제 (최소 8자)

---

## 2. 작업 목표 (Work Objectives)

| # | 목표 | 완료 기준 |
|---|------|----------|
| O1 | Supabase/Google OAuth 의존성 완전 제거 | `supabase` 패키지 미참조, 관련 config/코드 전무 |
| O2 | 비밀번호 기반 로컬 인증 구현 | bcrypt 해싱(cost=12), 이메일+비밀번호 로그인 동작 |
| O3 | 세션에 uid+email+role 저장 (토큰 대체) | 쿠키에 `{"uid", "email", "role"}` 저장, 쿠키 서명 검증만으로 인증 (매 요청 DB 조회 불필요) |
| O4 | 관리자 사용자 관리 기능 | 사용자 생성(이메일+임시비번), 비밀번호 초기화 API/UI |
| O5 | DB 스키마 마이그레이션 | `password_hash`, `is_active`, `failed_login_count`, `locked_until`, `password_changed_at` 컬럼 추가, `is_admin()` 함수 제거 |
| O6 | 기존 기능 무결성 유지 | RBAC, CSRF, 기존 라우트 모두 정상 동작 |
| O7 | brute-force 방어 | IP당 5회 실패 시 30초 대기, 계정당 20회 실패 시 15분 잠금 |

---

## 3. 가드레일

### Must Have
- 비밀번호는 반드시 bcrypt로 해싱 저장 (cost factor: 12)
- 비밀번호 정책: 최소 8자 (Pydantic validator에서 강제)
- 기존 세션 쿠키 구조(itsdangerous, httponly, samesite=lax) 유지
- CSRF 보호 유지 (starlette-csrf)
- 관리자만 사용자 생성/비밀번호 초기화 가능
- 로그인 실패 시 구체적인 오류 메시지 노출 금지 ("이메일 또는 비밀번호가 올바르지 않습니다")
- 최초 부트스트랩: 환경변수 또는 CLI 명령으로 초기 관리자 계정 생성 방법 제공
- 타이밍 공격 방지: 존재하지 않는 사용자도 dummy bcrypt.checkpw() 수행
- brute-force 방어: 계정 잠금 + IP 기반 rate limiting
- 기존 사용자 UUID 보존 (email 기준 매칭)

### Must NOT Have
- 사용자 자가 회원가입 (관리자만 계정 생성)
- 비밀번호 평문 저장 또는 로깅
- Supabase 패키지 잔존 참조
- 기존 `trading_accounts`, `strategy_configs` 등 비인증 테이블 변경

---

## 4. 태스크 흐름 (Task Flow)

```
[Task 1: DB 스키마 마이그레이션]
         |
         v
[Task 2: AuthService 교체 + SessionManager 수정]
         |
         v
[Task 3: API 엔드포인트 + 미들웨어 교체]
        / \
       v   v
[Task 4]  [Task 5]   (병렬 가능)
프론트엔드  관리자 기능
       \ /
        v
[Task 6: 의존성 정리 + 설정 정리 + 부트스트랩]
```

---

## 5. 상세 태스크

### Task 1: DB 스키마 마이그레이션

**목적:** `user_profiles` 테이블에 비밀번호 해시 및 보안 관련 컬럼 추가, Supabase 전용 DB 함수 제거

**변경 파일:**
- `alembic/versions/003_local_auth.py` (신규 생성)
- `app/models/user.py` (수정)

**상세:**

1. **Alembic 마이그레이션 `003_local_auth.py` 생성:**
   - `user_profiles` 테이블에 `password_hash: String(nullable=True)` 컬럼 추가
     - nullable=True인 이유: 기존 사용자 데이터 호환 (마이그레이션 후 관리자가 비번 설정)
   - `user_profiles` 테이블에 `is_active: Boolean(server_default="true")` 컬럼 추가
     - 계정 비활성화 기능 지원
   - `user_profiles` 테이블에 `failed_login_count: Integer(server_default="0")` 컬럼 추가
     - brute-force 방어용 실패 카운터
   - `user_profiles` 테이블에 `locked_until: TIMESTAMPTZ(nullable=True)` 컬럼 추가
     - 계정 잠금 만료 시각 (NULL = 잠금 아님)
   - `user_profiles` 테이블에 `password_changed_at: TIMESTAMPTZ(nullable=True)` 컬럼 추가
     - 비밀번호 변경 이력 추적
   - `user_profiles.email`에 UNIQUE 제약조건 추가 (로그인 식별자로 사용하므로 필수)
   - `is_admin()` SQL 함수 DROP (`auth.uid()`는 Supabase 전용이므로 제거)

2. **기존 사용자 UUID 보존 전략:**
   - 기존 `user_profiles` 레코드의 UUID(id)를 그대로 유지
   - `password_hash`만 NULL로 설정 (관리자가 이후 비밀번호 할당)
   - 새 사용자 생성 시 `create_user()`가 `uuid4()` 생성
   - email 기준으로 기존 사용자 매칭 (마이그레이션 시 데이터 변환 불필요)

3. **`app/models/user.py` 수정:**
   - `password_hash: Mapped[str | None]` 컬럼 추가
   - `is_active: Mapped[bool]` 컬럼 추가 (server_default="true")
   - `failed_login_count: Mapped[int]` 컬럼 추가 (server_default="0")
   - `locked_until: Mapped[datetime | None]` 컬럼 추가
   - `password_changed_at: Mapped[datetime | None]` 컬럼 추가

**수락 기준:**
- [ ] `alembic upgrade head` 정상 실행
- [ ] `\d user_profiles` 결과에 `password_hash`, `is_active`, `failed_login_count`, `locked_until`, `password_changed_at` 컬럼 존재
- [ ] `email` 컬럼에 UNIQUE 제약조건 적용
- [ ] `is_admin()` 함수 제거됨
- [ ] 기존 데이터 손실 없음 (기존 행의 `password_hash`는 NULL, UUID 보존)

---

### Task 2: AuthService 교체 + SessionManager 수정

**목적:** Supabase 클라이언트 기반 인증을 로컬 DB 기반 비밀번호 인증으로 교체, brute-force 방어 내장

**변경 파일:**
- `app/services/auth_service.py` (전면 재작성)
- `app/services/session_manager.py` (수정)

**상세:**

1. **`app/services/auth_service.py` 전면 재작성:**
   - Supabase import 및 클라이언트 코드 전부 제거
   - 생성자: `__init__(self, session_factory: async_sessionmaker)` -- AsyncSessionFactory 주입
   - main.py lifespan에서 `AuthService(session_factory=TradingSessionLocal)` 초기화
   - 각 메서드 내부에서 `async with self.session_factory() as session:` 패턴 사용
   - `async def authenticate(self, email: str, password: str) -> dict | None`
     - email로 `user_profiles` 조회
     - `locked_until` 확인: 현재 시각보다 미래이면 잠금 상태 -> None 반환
     - bcrypt.checkpw()로 비밀번호 검증 (bcrypt work factor: 12)
     - 타이밍 공격 방지: 사용자 미존재 시에도 dummy bcrypt.checkpw() 수행
     - 실패 시: `failed_login_count += 1`, 20회 도달 시 `locked_until = now + 15분` 설정
     - 성공 시: `failed_login_count = 0`, `locked_until = NULL` 리셋
     - is_active=False인 사용자 -> None 반환
     - 성공 시 `{"id": str(user.id), "email": user.email, "role": user.role}` 반환
     - 실패 시 None 반환
   - `async def get_user_by_id(self, user_id: str) -> dict | None`
     - UUID로 user_profiles 조회, is_active 체크
     - `{"id", "email", "role"}` 반환
   - `async def create_user(self, email: str, password: str, role: str = "user") -> dict`
     - 비밀번호 정책 검증: 최소 8자 (Pydantic validator에서도 강제하지만 서비스 레벨 이중 검증)
     - bcrypt.hashpw()로 해싱 후 INSERT (cost factor: 12)
     - 새 사용자는 uuid4()로 ID 생성
     - 중복 email 시 예외 발생
   - `async def reset_password(self, user_id: str, new_password: str) -> bool`
     - 새 비밀번호 bcrypt 해싱 후 UPDATE
     - `password_changed_at = now()` 업데이트
     - `failed_login_count = 0`, `locked_until = NULL` 리셋 (잠금 해제)
   - `async def set_user_active(self, user_id: str, active: bool) -> bool`
   - 기존 메서드 제거: `get_google_oauth_url`, `exchange_code_for_session`, `get_user_from_token`, `refresh_session`, `ensure_user_profile`, `get_user_role`

2. **`app/services/session_manager.py` 수정:**
   - `create_session_cookie(self, user_id: str, email: str, role: str) -> str`
     - payload: `{"uid": user_id, "email": email, "role": role}` (기존의 `{"at": ..., "rt": ...}` 대체)
   - `read_session_cookie(self, cookie_value: str) -> dict | None`
     - 반환값: `{"uid": "...", "email": "...", "role": "..."}` 또는 None
   - 매 요청 DB 조회 불필요 (쿠키 서명 검증만으로 인증)
   - 단, is_active 체크와 role 변경 즉시 반영을 위해 미들웨어에서 주기적(N번째 요청마다) 또는 중요 작업 시 DB 조회 수행

**수락 기준:**
- [ ] `supabase` import 완전 제거
- [ ] bcrypt 해싱/검증 정상 동작 (cost factor 12 확인)
- [ ] authenticate() 성공/실패/잠금 세 가지 케이스 모두 정상 동작
- [ ] 20회 연속 실패 시 계정 15분 잠금 확인
- [ ] 잠금 해제 후 로그인 성공 확인
- [ ] 타이밍 공격 방지 (사용자 미존재 시에도 bcrypt 비교 수행)
- [ ] 세션 쿠키에 uid, email, role 저장

---

### Task 3: API 엔드포인트 + 미들웨어 교체

**목적:** Google OAuth 엔드포인트를 이메일/비밀번호 로그인으로 교체, 미들웨어를 쿠키 서명 기반 인증으로 변경

**변경 파일:**
- `app/api/auth.py` (전면 재작성)
- `app/main.py` (LazyAuthMiddleware 수정, 서비스 초기화 변경)
- `app/middleware/auth_middleware.py` (수정 또는 제거 -- LazyAuthMiddleware가 대체)
- `app/schemas/auth.py` (수정)
- `app/dependencies.py` (수정)
- `app/middleware/csrf_middleware.py` (수정)

**상세:**

1. **`app/api/auth.py` 전면 재작성:**
   - `GET /api/auth/google` 제거
   - `GET /api/auth/callback` 제거
   - `POST /api/auth/login` 추가 (신규)
     - Request body: `{"email": str, "password": str}`
     - Pydantic validator: password 최소 8자
     - auth_service.authenticate() 호출
     - 성공 시: session_manager.create_session_cookie(user_id, email, role)로 쿠키 설정, 200 응답
     - 실패 시: 401 응답 (일반적인 오류 메시지)
   - `POST /api/auth/logout` 유지 (기존 로직 그대로)
   - `GET /api/auth/me` 유지 (기존 로직 그대로)

2. **`app/schemas/auth.py` 수정:**
   - `LoginUrlResponse` 제거
   - `LoginRequest` 추가: `email: str, password: str`
     - password에 `min_length=8` validator
   - `LoginResponse` 추가: `success: bool, user: UserResponse | None`
   - `UserResponse` 유지

3. **`app/main.py` 수정:**

   a. **서비스 초기화 변경 (lifespan 함수):**
   - `AuthService(supabase_url=..., ...)` -> `AuthService(session_factory=TradingSessionLocal)`
   - Supabase 관련 설정 참조 제거

   b. **LazyAuthMiddleware 수정:**
   - 쿠키에서 `{"uid", "email", "role"}` 추출 -> `request.state.user` 에 `{"id", "email", "role"}` 설정 (uid→id 키 매핑으로 하위 코드 변경 최소화)
   - 토큰 리프레시 로직 전체 제거 (send_with_cookie 래퍼 불필요)
   - `access_token` scope 참조 제거
   - 기존 세션 형식(`{"at": ..., "rt": ...}`) 감지 시 로그아웃 처리 (graceful transition -- 쿠키 삭제 후 /login 리다이렉트)
   - `scope["state"]["user"]` 주입은 유지
   - `scope["state"]["access_token"]` 제거 (더 이상 불필요)
   - public_paths에서 `/api/auth/google`, `/api/auth/callback` 제거 -> `/api/auth/login` 추가

   c. **import 정리:**
   - `from app.services.auth_service import AuthService` 유지 (내부 구현만 변경됨)
   - `from app.middleware.auth_middleware import AuthMiddleware` import 제거 가능

4. **`app/middleware/auth_middleware.py`:**
   - 이 파일은 `LazyAuthMiddleware`로 이미 대체되어 사용되지 않으나, import만 남아있음
   - import 제거 후 파일 유지 또는 삭제 (LazyAuthMiddleware가 main.py에 인라인되어 있으므로)

5. **`app/dependencies.py` 수정:**
   - `get_auth_service` 유지 (시그니처 동일, 내부 구현만 변경)
   - `get_session_manager` 반환 타입 확인 (시그니처 동일, 내부 구현만 변경)
   - `get_current_user` 유지 (request.state.user 접근 방식 동일)
   - `require_admin` 유지

6. **`app/middleware/csrf_middleware.py` 수정:**
   - `CSRF_EXEMPT_PATHS`에서 `/api/auth/callback` 제거
   - `/api/auth/login`은 exempt하지 않음 (login.html에서 CSRF 토큰을 meta tag으로 주입하므로 CSRF 보호 유지)

**수락 기준:**
- [ ] `POST /api/auth/login` 으로 이메일+비밀번호 로그인 성공
- [ ] curl로 `POST /api/auth/login` 직접 검증 가능
- [ ] 잘못된 자격증명 시 401 + 일반적 오류 메시지
- [ ] 미인증 상태로 보호된 경로 접근 시 API는 401, SSR은 302 (/login 리다이렉트)
- [ ] 로그인 후 세션 쿠키 설정, 이후 요청에서 인증 유지
- [ ] 세션 만료 시 /login으로 리다이렉트 (SSR) 또는 401 (API)
- [ ] `/api/auth/google`, `/api/auth/callback` 경로 완전 제거
- [ ] 기존 `{"at", "rt"}` 형식 세션 쿠키로 접근 시 로그아웃 처리 (graceful transition)
- [ ] 기존 보호된 엔드포인트 (accounts, dashboard, admin 등) 인증 정상 동작

---

### Task 4: 프론트엔드(템플릿/JS) 수정

**목적:** Google 로그인 버튼을 이메일/비밀번호 로그인 폼으로 교체

**변경 파일:**
- `app/dashboard/templates/login.html` (전면 재작성)
- `app/dashboard/static/js/main.js` (login 관련 함수 추가)
- `app/dashboard/static/css/style.css` (로그인 폼 스타일 추가 -- 필요 시)

**상세:**

1. **`login.html` 전면 재작성:**
   - Google 로그인 버튼 + SVG 아이콘 제거
   - 이메일/비밀번호 입력 폼으로 교체:
     - `<form id="login-form">` with `email` input, `password` input, submit button
     - 에러 메시지 표시 영역 (`<div id="login-error">`)
     - CSRF 토큰을 meta tag으로 주입 (`<meta name="csrf-token" content="...">`)
   - JS에서 `POST /api/auth/login` 호출, 성공 시 `/accounts`로 리다이렉트

2. **`main.js` 수정:**
   - `handleLogin()` 함수 추가
     - form submit 이벤트 가로채기
     - `POST /api/auth/login` with `{email, password}` + CSRF 토큰
     - 성공: `window.location.href = '/accounts'`
     - 실패: 에러 메시지 표시
   - `logout()` 함수 유지 (변경 없음)

3. **`base.html`:**
   - 변경 없음 (네비게이션의 user.email 표시, logout 버튼은 그대로 동작)

**수락 기준:**
- [ ] 로그인 페이지에 이메일/비밀번호 폼 표시
- [ ] Google 관련 UI 요소 완전 제거
- [ ] 로그인 페이지 정상 렌더링 확인
- [ ] JS fetch로 POST /api/auth/login 정상 호출 확인
- [ ] 로그인 성공 시 /accounts로 리다이렉트
- [ ] 로그인 실패 시 사용자 친화적 에러 메시지 표시
- [ ] CSRF 토큰 정상 전송

---

### Task 5: 관리자 사용자 관리 기능 추가

**목적:** 관리자가 사용자 생성, 비밀번호 초기화, 계정 활성/비활성화 가능

**변경 파일:**
- `app/api/admin.py` (엔드포인트 추가)
- `app/schemas/auth.py` (스키마 추가)
- `app/dashboard/templates/admin.html` (UI 추가)
- `app/dashboard/static/js/main.js` (관리자 함수 추가)

**상세:**

1. **`app/api/admin.py`에 엔드포인트 추가:**
   - `POST /api/admin/users` -- 사용자 생성
     - Body: `{"email": str, "password": str, "role": str = "user"}`
     - auth_service.create_user() 호출
     - 중복 email 시 409 Conflict
   - `POST /api/admin/users/{user_id}/reset-password` -- 비밀번호 초기화
     - Body: `{"new_password": str}`
     - auth_service.reset_password() 호출
   - `PUT /api/admin/users/{user_id}/active` -- 계정 활성/비활성화
     - Body: `{"is_active": bool}`
     - auth_service.set_user_active() 호출
   - `PUT /api/admin/users/{user_id}/role` -- 기존 역할 변경 유지 (현재 POST -> PUT로 통일)

2. **`app/schemas/auth.py`에 추가:**
   - `CreateUserRequest`: email, password (min_length=8), role
   - `ResetPasswordRequest`: new_password (min_length=8)
   - `SetActiveRequest`: is_active

3. **`admin.html` Users 섹션 강화:**
   - 사용자 생성 폼 추가 (이메일, 임시 비밀번호, 역할 선택)
   - 사용자 테이블에 컬럼 추가: 활성 상태, 액션 버튼들 (비밀번호 초기화, 활성/비활성화)

4. **`main.js`에 관리자 함수 추가:**
   - `createUser()` -- 사용자 생성 폼 제출
   - `resetUserPassword(userId)` -- 비밀번호 초기화 (모달 또는 prompt)
   - `toggleUserActive(userId, currentState)` -- 활성/비활성 토글
   - `loadAdminUsers()` 수정 -- 새 컬럼/액션 버튼 반영

**수락 기준:**
- [ ] 관리자 API로 사용자 CRUD 동작 확인 (생성/조회/수정/비활성화)
- [ ] 관리자가 새 사용자를 생성할 수 있음
- [ ] 중복 이메일로 생성 시 적절한 오류 표시
- [ ] 관리자가 사용자 비밀번호를 초기화할 수 있음
- [ ] 관리자가 사용자 계정을 비활성화/활성화할 수 있음
- [ ] 비활성화된 사용자는 로그인 불가
- [ ] 비관리자는 이 기능에 접근 불가 (403)

---

### Task 6: 의존성 정리 + 설정 정리 + 초기 관리자 부트스트랩

**목적:** Supabase 관련 모든 잔존물 제거, 초기 관리자 계정 생성 방법 제공

**변경 파일:**
- `requirements.txt` (수정)
- `pyproject.toml` (수정)
- `app/config.py` (수정)
- `.env.example` (수정)
- `docs/PROJECT_STRUCTURE.md` (수정)
- `scripts/create_admin.py` (신규 생성)

**상세:**

1. **의존성 제거:**
   - `requirements.txt`: `supabase>=2.0.0` 제거, `bcrypt>=4.0.0` 추가
   - `pyproject.toml`: `supabase` 제거, `bcrypt` 추가

2. **`app/config.py` 수정:**
   - `supabase_url`, `supabase_anon_key`, `supabase_service_role_key` 제거
   - `initial_admin_email: str = ""` 추가 (최초 부트스트랩용)
   - `initial_admin_password: str = ""` 추가

3. **`.env.example` 수정:**
   - `SUPABASE_*` 환경변수 전체 제거
   - 초기 관리자 설정 섹션 추가:
     ```
     # ===== Initial Admin (최초 실행 시에만 사용) =====
     INITIAL_ADMIN_EMAIL=admin@example.com
     INITIAL_ADMIN_PASSWORD=change-me-immediately
     ```

4. **`scripts/create_admin.py` 생성:**
   - 독립 실행 스크립트: `python scripts/create_admin.py --email admin@example.com --password <password>`
   - 또는 lifespan에서 `INITIAL_ADMIN_EMAIL` 환경변수가 설정되어 있고 해당 이메일의 사용자가 없으면 자동 생성

5. **`docs/PROJECT_STRUCTURE.md` 수정:**
   - Supabase 관련 설명 제거
   - 로컬 인증 시스템 설명으로 교체

**수락 기준:**
- [ ] `pip install` 시 supabase 패키지 불필요
- [ ] bcrypt 패키지 정상 설치
- [ ] `SUPABASE_*` 환경변수 불필요
- [ ] 초기 관리자 계정 생성 가능 (스크립트 또는 환경변수)
- [ ] 코드베이스 전체에서 "supabase" 문자열 검색 결과 0건 (docs 제외)
- [ ] CSRF exempt 경로가 새 엔드포인트에 맞게 업데이트

---

## 6. 실행 순서 및 의존성

```
Task 1 (DB 마이그레이션)
  -> Task 2 (AuthService + SessionManager) [Task 1의 모델 변경에 의존]
    -> Task 3 (API + 미들웨어) [Task 2의 새 AuthService에 의존]
    -> Task 4 (프론트엔드) [Task 3의 새 API 엔드포인트에 의존]
    -> Task 5 (관리자 기능) [Task 2, 3에 의존]
  -> Task 6 (정리 + 부트스트랩) [모든 Task 완료 후 또는 병렬 가능]
```

**병렬 가능 구간:**
- Task 4와 Task 5는 Task 3 완료 후 병렬 진행 가능
- Task 6은 대부분 독립적이므로 Task 1 이후 일부 병렬 가능 (의존성/설정 파일 정리)

---

## 7. 리스크 및 주의사항

### HIGH 리스크
- **기존 사용자 잠김**: 마이그레이션 후 기존 `user_profiles` 행에 `password_hash`가 NULL이므로 로그인 불가. 반드시 관리자가 비밀번호를 설정해주어야 함.
  - **대응**: 마이그레이션 직후 `scripts/create_admin.py` 또는 환경변수 부트스트랩으로 최소 1명의 관리자 계정 설정. 기존 사용자에 대해서는 관리자가 비밀번호 초기화 기능으로 비번 할당.
  - **UUID 보존**: 기존 `user_profiles` 레코드의 UUID를 보존하므로, `trading_accounts` 등의 외래키 관계 유지.

- **인증 우회 가능성**: 미들웨어 변경 중 public_paths 설정 오류로 보호된 경로가 노출될 수 있음.
  - **대응**: 변경 후 모든 보호된 엔드포인트에 대해 미인증 상태 접근 테스트 필수.

### MEDIUM 리스크
- **세션 무효화**: 기존 Supabase 토큰 기반 세션 쿠키가 새 형식(`{"uid", "email", "role"}`)과 호환되지 않으므로 배포 즉시 모든 기존 세션 무효화됨.
  - **대응**: 기존 `{"at", "rt"}` 형식 감지 시 graceful하게 로그아웃 처리 (쿠키 삭제 + /login 리다이렉트). 배포 후 모든 사용자 재로그인 필요.

- **Supabase RLS 의존**: 현재 직접 DB 연결(`DATABASE_URL`)을 사용하고 RLS를 바이패스하고 있으므로 (`app/db/session.py`), `is_admin()` 함수 제거가 실질적 영향은 없을 것으로 예상. 다만 Supabase 대시보드에서 RLS 정책을 설정해둔 경우 확인 필요.

### LOW 리스크 (v2에서 해결됨)
- ~~비밀번호 정책~~ -> 최소 8자 정책 포함
- ~~브루트포스 방어~~ -> IP당 5회/30초, 계정당 20회/15분 잠금 포함

---

## 8. 테스트 계획

### 단위 테스트
- `AuthService.authenticate()` -- 성공, 실패, 비활성 사용자, 존재하지 않는 이메일
- `AuthService.authenticate()` -- 계정 잠금 케이스 (20회 실패 후 잠금, 15분 후 해제)
- `AuthService.authenticate()` -- 타이밍 공격 방지 (미존재 사용자도 bcrypt 수행)
- `AuthService.create_user()` -- 성공, 중복 이메일
- `AuthService.create_user()` -- 8자 미만 비밀번호 거부
- `AuthService.reset_password()` -- 성공, 존재하지 않는 사용자
- `AuthService.reset_password()` -- 잠금 해제 + password_changed_at 업데이트 확인
- `SessionManager.create_session_cookie()` / `read_session_cookie()` -- uid+email+role 기반 페이로드

### 통합 테스트
- `POST /api/auth/login` -- 성공 시 쿠키 설정 + 200
- `POST /api/auth/login` -- 실패 시 401 + 쿠키 미설정
- `POST /api/auth/login` -- 잠금 상태에서 401 (올바른 비밀번호여도)
- `POST /api/auth/logout` -- 쿠키 삭제
- `GET /api/auth/me` -- 인증된 상태에서 사용자 정보 반환
- 보호된 엔드포인트 미인증 접근 시 401/302

### 관리자 기능 테스트
- `POST /api/admin/users` -- 사용자 생성 성공/중복 에러
- `POST /api/admin/users/{id}/reset-password` -- 비밀번호 초기화
- `PUT /api/admin/users/{id}/active` -- 활성/비활성 토글
- 비관리자가 관리자 API 접근 시 403

### E2E/수동 테스트
- 로그인 페이지 -> 이메일+비밀번호 입력 -> 로그인 -> /accounts 도착
- 잘못된 비밀번호 -> 에러 메시지 표시
- 로그아웃 -> /login 리다이렉트
- 관리자: 사용자 생성 -> 해당 사용자로 로그인 성공
- 관리자: 사용자 비활성화 -> 해당 사용자 로그인 실패
- 세션 쿠키 만료 후 -> /login 리다이렉트
- 20회 연속 로그인 실패 -> 계정 잠금 확인 -> 15분 후 해제 확인

---

## 9. 파일별 변경 요약

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `alembic/versions/003_local_auth.py` | 신규 | password_hash, is_active, failed_login_count, locked_until, password_changed_at 컬럼, email UNIQUE, is_admin() 제거 |
| `app/models/user.py` | 수정 | password_hash, is_active, failed_login_count, locked_until, password_changed_at 필드 추가 |
| `app/services/auth_service.py` | 전면 재작성 | Supabase -> bcrypt/DB 기반 인증, AsyncSessionFactory 주입, brute-force 방어 |
| `app/services/session_manager.py` | 수정 | 토큰 페이로드 -> uid+email+role 페이로드 |
| `app/api/auth.py` | 전면 재작성 | OAuth -> 이메일/비밀번호 로그인 |
| `app/schemas/auth.py` | 수정 | LoginRequest/Response 추가(password min_length=8), LoginUrlResponse 제거 |
| `app/main.py` | 수정 | AuthService(session_factory) 초기화, LazyAuthMiddleware uid+email+role 추출, 토큰 리프레시 제거, 기존 세션 graceful transition |
| `app/middleware/auth_middleware.py` | 수정/제거 가능 | import 정리 (LazyAuthMiddleware가 대체) |
| `app/middleware/csrf_middleware.py` | 수정 | /api/auth/callback exempt 제거, /api/auth/login은 CSRF 보호 유지 |
| `app/dependencies.py` | 수정 (minor) | get_auth_service, get_session_manager 반환 타입 확인, access_token 관련 코드 제거 |
| `app/config.py` | 수정 | supabase_url/anon_key/service_role_key 제거, initial_admin_email/password 추가 |
| `app/api/admin.py` | 수정 | 사용자 생성/비밀번호 초기화 엔드포인트 추가 |
| `app/dashboard/templates/login.html` | 전면 재작성 | Google 버튼 -> 이메일/비밀번호 폼 |
| `app/dashboard/templates/admin.html` | 수정 | 사용자 관리 UI 강화 |
| `app/dashboard/static/js/main.js` | 수정 | handleLogin(), 관리자 사용자 관리 함수 추가 |
| `.env.example` | 수정 | SUPABASE_* 제거, INITIAL_ADMIN_EMAIL/PASSWORD 추가 |
| `requirements.txt` | 수정 | supabase 제거, bcrypt 추가 |
| `pyproject.toml` | 수정 | supabase 제거, bcrypt 추가 |
| `scripts/create_admin.py` | 신규 | 초기 관리자 생성 CLI 스크립트 |
| `docs/PROJECT_STRUCTURE.md` | 수정 | 인증 설명 업데이트 |

---

## 10. 성공 기준 (최종 검증)

- [ ] `supabase` 패키지가 의존성에 없음
- [ ] 코드베이스에서 `supabase` 문자열 검색 결과 0건 (docs 제외)
- [ ] 코드베이스에서 `google_oauth`, `access_token`, `refresh_token` (인증 컨텍스트) 참조 없음
- [ ] 이메일+비밀번호로 로그인/로그아웃 정상 동작
- [ ] bcrypt cost factor 12로 해싱 확인
- [ ] 비밀번호 정책 (최소 8자) 적용 확인
- [ ] brute-force 방어 동작 확인 (계정 20회/15분)
- [ ] 관리자가 사용자 생성/비밀번호 초기화/활성 토글 가능
- [ ] 비관리자는 관리자 기능 접근 불가
- [ ] CSRF 보호 정상 동작
- [ ] 기존 trading 기능 (accounts, dashboard, strategies, backtest) 모두 정상 동작
- [ ] 비밀번호가 bcrypt로 안전하게 저장
- [ ] 초기 관리자 계정 부트스트랩 방법 문서화
- [ ] 기존 사용자 UUID 보존 확인

---

## 구현 시 참고 사항 (Architect/Critic 권고)

1. **쿠키 `uid` → `request.state.user["id"]` 매핑**: 미들웨어에서 쿠키의 `uid` 키를 `id`로 매핑하여 하위 코드(`accounts.py`, `dashboard.py`, `backtest.py` 등) 변경 최소화
2. **bcrypt 72바이트 제한**: 비밀번호 최대 길이 128자 제한 권장 (bcrypt 입력 72바이트 한도)
3. **`is_admin()` SQL 함수**: `alembic/versions/001_initial_schema.py` 192-204행에 정의된 Supabase RLS 전용 함수. 새 마이그레이션에서 DROP 처리
4. **`TradingSessionLocal`**: `app/db/session.py`에 이미 `async_sessionmaker` 타입으로 존재. AuthService 생성자에 그대로 주입 가능

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| v1 | 2026-02-25 | 초기 계획 작성 |
| v2 | 2026-02-25 | Architect/Critic 리뷰 피드백 반영: DB 컬럼 보강(failed_login_count, locked_until, password_changed_at), UUID 보존 전략 명시, AuthService DB 세션 주입 패턴 상세화, brute-force 방어 로직 추가, 세션 쿠키 페이로드 확장(uid+email+role), 미들웨어 변경 상세화(토큰 리프레시 제거, 기존 세션 graceful transition), 누락 파일 변경사항 추가(config.py, dependencies.py, csrf_middleware.py, pyproject.toml, .env.example), 비밀번호 정책(최소 8자) 추가, bcrypt cost factor 12 명시, 모든 태스크에 구체적 수락 기준 추가 |
