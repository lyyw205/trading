# crypto-multi-trader í”„ë¡œì íŠ¸ êµ¬ì¡° ë° íŒŒì¼ë³„ ìƒì„¸ ì„¤ëª…

> ë©€í‹° ê³„ì • ì•”í˜¸í™”í ìë™ë§¤ë§¤ ë´‡ - íŒŒì¼ë³„ êµ¬ì¡° í•´ì„¤ì„œ
> ì‘ì„±ì¼: 2026-02-24 | ìµœì¢… ìˆ˜ì •ì¼: 2026-02-26

---

## ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë‚´ìš© |
|------|------|
| 2026-02-26 | ì½¤ë³´ ê¸°ë°˜ ì‹œìŠ¤í…œ ì „í™˜, WebSocket ìº”ë“¤ ìˆ˜ì§‘, Buy Pause, ë¡œì»¬ ì¸ì¦, ë°±í…ŒìŠ¤íŠ¸ ì¬ì„¤ê³„ ë°˜ì˜ |
| 2026-02-24 | ìµœì´ˆ ì‘ì„± |

---

## ë³€ê²½ ë§ˆì»¤ ë²”ë¡€

| ë§ˆì»¤ | ì˜ë¯¸ |
|------|------|
| ğŸ†• | ìƒˆë¡œ ì¶”ê°€ë¨ (ì›ë³¸ì— ì—†ì—ˆìŒ) |
| âœï¸ | ìˆ˜ì •ë¨ (ì›ë³¸ì—ì„œ í¬ê²Œ ë³€ê²½) |
| âŒ | ì‚­ì œ/deprecated (ì›ë³¸ì— ìˆì—ˆìœ¼ë‚˜ ì œê±° ë˜ëŠ” ëŒ€ì²´ë¨) |

ë§ˆì»¤ê°€ ì—†ëŠ” í•­ëª©ì€ ì›ë³¸ê³¼ ë™ì¼.

---

## ëª©ì°¨

1. [í”„ë¡œì íŠ¸ ì „ì²´ ê°œìš”](#1-í”„ë¡œì íŠ¸-ì „ì²´-ê°œìš”)
2. [ë£¨íŠ¸ ë””ë ‰í† ë¦¬ íŒŒì¼](#2-ë£¨íŠ¸-ë””ë ‰í† ë¦¬-íŒŒì¼)
3. [app/ - ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜](#3-app---ë©”ì¸-ì• í”Œë¦¬ì¼€ì´ì…˜)
4. [app/models/ - ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸](#4-appmodels---ë°ì´í„°ë² ì´ìŠ¤-ëª¨ë¸)
5. [app/db/ - ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê³„ì¸µ](#5-appdb---ë°ì´í„°ë² ì´ìŠ¤-ì ‘ê·¼-ê³„ì¸µ)
6. [app/exchange/ - ê±°ë˜ì†Œ í´ë¼ì´ì–¸íŠ¸](#6-appexchange---ê±°ë˜ì†Œ-í´ë¼ì´ì–¸íŠ¸)
7. [app/strategies/ - ë§¤ë§¤ ì „ëµ í”ŒëŸ¬ê·¸ì¸](#7-appstrategies---ë§¤ë§¤-ì „ëµ-í”ŒëŸ¬ê·¸ì¸)
8. [app/services/ - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„œë¹„ìŠ¤](#8-appservices---ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§-ì„œë¹„ìŠ¤)
9. [app/middleware/ - HTTP ë¯¸ë“¤ì›¨ì–´](#9-appmiddleware---http-ë¯¸ë“¤ì›¨ì–´)
10. [app/api/ - REST API ì—”ë“œí¬ì¸íŠ¸](#10-appapi---rest-api-ì—”ë“œí¬ì¸íŠ¸)
11. [app/schemas/ - API ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆ](#11-appschemas---api-ìš”ì²­ì‘ë‹µ-ìŠ¤í‚¤ë§ˆ)
12. [app/dashboard/ - ëŒ€ì‹œë³´ë“œ UI (SSR)](#12-appdashboard---ëŒ€ì‹œë³´ë“œ-ui-ssr)
13. [app/utils/ - ìœ í‹¸ë¦¬í‹°](#13-apputils---ìœ í‹¸ë¦¬í‹°)
14. [alembic/ - DB ë§ˆì´ê·¸ë ˆì´ì…˜](#14-alembic---db-ë§ˆì´ê·¸ë ˆì´ì…˜)
15. [backtest/ - ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„](#15-backtest---ë°±í…ŒìŠ¤íŠ¸-ì—”ì§„)
16. [scripts/ - ìš´ì˜ ìŠ¤í¬ë¦½íŠ¸](#16-scripts---ìš´ì˜-ìŠ¤í¬ë¦½íŠ¸)
17. [docker/ - ì»¨í…Œì´ë„ˆ ë°°í¬](#17-docker---ì»¨í…Œì´ë„ˆ-ë°°í¬)
18. [systemd/ - ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤](#18-systemd---ì‹œìŠ¤í…œ-ì„œë¹„ìŠ¤)
19. [tests/ - í…ŒìŠ¤íŠ¸](#19-tests---í…ŒìŠ¤íŠ¸)
20. [ë°ì´í„° íë¦„ ìš”ì•½](#20-ë°ì´í„°-íë¦„-ìš”ì•½)

---

## 1. âœï¸ í”„ë¡œì íŠ¸ ì „ì²´ ê°œìš”

ì´ í”„ë¡œì íŠ¸ëŠ” **ë°”ì´ë‚¸ìŠ¤(Binance) ê±°ë˜ì†Œì—ì„œ ì•”í˜¸í™”íë¥¼ ìë™ìœ¼ë¡œ ë§¤ë§¤í•˜ëŠ” ë´‡**ì…ë‹ˆë‹¤.
ê¸°ì¡´ `btc-staking-bot`(ë‹¨ì¼ ê³„ì •)ì„ í™•ì¥í•˜ì—¬, **ì—¬ëŸ¬ ê³„ì •ì„ ë™ì‹œì— ìš´ì˜**í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
BTCUSDT ì™¸ì— ETHUSDT ë“± ë‹¤ì–‘í•œ ì‹¬ë³¼ì„ ì§€ì›í•©ë‹ˆë‹¤.

### âœï¸ í•µì‹¬ íŠ¹ì§•
- **ë©€í‹° ê³„ì •**: ì—¬ëŸ¬ ë°”ì´ë‚¸ìŠ¤ ê³„ì •ì„ ë…ë¦½ì ìœ¼ë¡œ ìš´ì˜. ê° ê³„ì •ë§ˆë‹¤ ë³„ë„ì˜ API í‚¤, ì½¤ë³´ ì„¤ì •, ë§¤ë§¤ ë£¨í”„ë¥¼ ê°€ì§
- **ì½¤ë³´ ê¸°ë°˜ ì „ëµ**: Buy Logic + Sell Logicì„ ë¶„ë¦¬í•˜ì—¬ ì¡°í•©í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ ë°©ì‹. í•˜ë‚˜ì˜ ê³„ì •ì— ì—¬ëŸ¬ ì½¤ë³´ë¥¼ ë™ì‹œ ìš´ì˜ ê°€ëŠ¥
- **âœï¸ ë¡œì»¬ DB ì¸ì¦**: ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ê¸°ë°˜ ë¡œì»¬ ì¸ì¦ (bcrypt). ê³„ì •ë³„ ì ‘ê·¼ ê¶Œí•œ ì œì–´
- **ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ**: ê³„ì •ë³„ ì°¨íŠ¸, ë¡œíŠ¸(ë§¤ìˆ˜ ë¬¶ìŒ) í˜„í™©, ì „ëµ íŒŒë¼ë¯¸í„° ì‹¤ì‹œê°„ ì¡°ì •
- **ì¥ì•  ê²©ë¦¬**: ì„œí‚· ë¸Œë ˆì´ì»¤(5íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ ìë™ ë¹„í™œì„±í™”), ì§€ìˆ˜ ë°±ì˜¤í”„, API ì†ë„ ì œí•œ
- **ğŸ†• ì‹¤ì‹œê°„ ìº”ë“¤ ìˆ˜ì§‘**: WebSocket ê¸°ë°˜ 1ë¶„ë´‰ ìˆ˜ì‹  + ë‹¤ì¤‘ íƒ€ì„í”„ë ˆì„(5m/1h/1d) ì§‘ê³„
- **ğŸ†• Buy Pause**: ì”ê³  ë¶€ì¡± ì‹œ ë§¤ìˆ˜ ìë™ ì¼ì‹œì •ì§€ (ACTIVE â†’ THROTTLED â†’ PAUSED ìƒíƒœ ê¸°ê³„)

### âœï¸ ê¸°ìˆ  ìŠ¤íƒ
```
Python 3.12+ / FastAPI / SQLAlchemy 2.0 (async) / PostgreSQL
bcrypt (ë¡œì»¬ ì¸ì¦) / python-binance WebSocket / Jinja2 (SSR)
aiolimiter / MultiFernet / itsdangerous / Alembic
```

### âœï¸ ì „ì²´ í´ë” íŠ¸ë¦¬
```
crypto-multi-trader/
â”œâ”€â”€ app/                          # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ
â”‚   â”œâ”€â”€ main.py                   # FastAPI ì•± ì§„ì…ì 
â”‚   â”œâ”€â”€ config.py                 # í™˜ê²½ ì„¤ì •
â”‚   â”œâ”€â”€ dependencies.py           # FastAPI ì˜ì¡´ì„± ì£¼ì…
â”‚   â”œâ”€â”€ models/                   # SQLAlchemy DB ëª¨ë¸ (14ê°œ í…Œì´ë¸”)
â”‚   â”œâ”€â”€ db/                       # ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ + ë¦¬í¬ì§€í† ë¦¬ (7ê°œ)
â”‚   â”œâ”€â”€ exchange/                 # ê±°ë˜ì†Œ í´ë¼ì´ì–¸íŠ¸ (Binance + ë°±í…ŒìŠ¤íŠ¸)
â”‚   â”œâ”€â”€ strategies/               # ë§¤ë§¤ ì „ëµ í”ŒëŸ¬ê·¸ì¸ (buys/ sells/ ë¶„ë¦¬)
â”‚   â”‚   â”œâ”€â”€ buys/                 # Buy Logic êµ¬í˜„ì²´
â”‚   â”‚   â””â”€â”€ sells/                # Sell Logic êµ¬í˜„ì²´
â”‚   â”œâ”€â”€ services/                 # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„œë¹„ìŠ¤ (12ê°œ)
â”‚   â”œâ”€â”€ middleware/               # HTTP ë¯¸ë“¤ì›¨ì–´ (ì¸ì¦ + CSRF)
â”‚   â”œâ”€â”€ api/                      # REST API ë¼ìš°í„° (8ê°œ)
â”‚   â”œâ”€â”€ schemas/                  # Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ dashboard/                # ëŒ€ì‹œë³´ë“œ UI (í…œí”Œë¦¿ + CSS + JS)
â”‚   â””â”€â”€ utils/                    # ìœ í‹¸ë¦¬í‹° (ì•”í˜¸í™” + ë¡œê¹…)
â”œâ”€â”€ alembic/                      # DB ë§ˆì´ê·¸ë ˆì´ì…˜
â”œâ”€â”€ backtest/                     # ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„
â”œâ”€â”€ scripts/                      # ìš´ì˜ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ docker/                       # Docker ë°°í¬ ì„¤ì •
â”œâ”€â”€ systemd/                      # systemd ì„œë¹„ìŠ¤ íŒŒì¼
â””â”€â”€ tests/                        # í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬
```

---

## 2. ë£¨íŠ¸ ë””ë ‰í† ë¦¬ íŒŒì¼

### âœï¸ `.env.example`
í™˜ê²½ ë³€ìˆ˜ í…œí”Œë¦¿. ì‹¤ì œ ìš´ì˜ ì‹œ `.env` íŒŒì¼ë¡œ ë³µì‚¬í•˜ì—¬ ê°’ì„ ì±„ì›€.

ì£¼ìš” ì„¤ì •ê°’:
- `DATABASE_URL`: PostgreSQL ì§ì ‘ ì—°ê²° ì£¼ì†Œ (íŠ¸ë ˆì´ë”© ì—”ì§„ìš©)
- `ENCRYPTION_KEYS`: API í‚¤ ì•”í˜¸í™”ìš© Fernet í‚¤ (ì‰¼í‘œ êµ¬ë¶„, ì²« ë²ˆì§¸ê°€ ìµœì‹ )
- `SESSION_SECRET_KEY`: ì„¸ì…˜ ì¿ í‚¤ ì„œëª… í‚¤
- `CSRF_SECRET`: CSRF ë°©ì–´ í† í° ì‹œí¬ë¦¿
- `API_RATE_LIMIT`: ë°”ì´ë‚¸ìŠ¤ API ë¶„ë‹¹ ìµœëŒ€ í˜¸ì¶œ ê°€ì¤‘ì¹˜ (ê¸°ë³¸ 1000)
- `ğŸ†• INITIAL_ADMIN_EMAIL`, `INITIAL_ADMIN_PASSWORD`: ì•± ìµœì´ˆ ê¸°ë™ ì‹œ ìë™ ìƒì„±í•  ê´€ë¦¬ì ê³„ì •

> âŒ ì œê±°ë¨: `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` (ë¡œì»¬ ì¸ì¦ìœ¼ë¡œ ì „í™˜)

### `pyproject.toml`
Python í”„ë¡œì íŠ¸ ë©”íƒ€ë°ì´í„°. í”„ë¡œì íŠ¸ ì´ë¦„, ë²„ì „, Python ë²„ì „ ìš”êµ¬ì‚¬í•­ ë“± ì •ì˜.

### `requirements.txt`
Python íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ëª©ë¡. ì£¼ìš” íŒ¨í‚¤ì§€:
- `fastapi`, `uvicorn`: ì›¹ í”„ë ˆì„ì›Œí¬ + ASGI ì„œë²„
- `sqlalchemy[asyncio]`, `asyncpg`: ë¹„ë™ê¸° DB ORM
- `python-binance`: ë°”ì´ë‚¸ìŠ¤ API í´ë¼ì´ì–¸íŠ¸ (WebSocket í¬í•¨)
- `bcrypt`: ë¡œì»¬ ì¸ì¦ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ
- `itsdangerous`: ì„¸ì…˜ ì¿ í‚¤ ì„œëª…
- `starlette-csrf`: CSRF ë³´í˜¸ ë¯¸ë“¤ì›¨ì–´
- `aiolimiter`: ë¹„ë™ê¸° ì†ë„ ì œí•œê¸°
- `cryptography`: MultiFernet ì•”í˜¸í™”
- `jinja2`: HTML í…œí”Œë¦¿ ì—”ì§„

### `.gitignore`
Gitì—ì„œ ë¬´ì‹œí•  íŒŒì¼ íŒ¨í„´. `.env`, `__pycache__`, `.venv` ë“±.

### `alembic.ini`
Alembic(DB ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬) ì„¤ì • íŒŒì¼. DB ì—°ê²° ë¬¸ìì—´ê³¼ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ë¥¼ ì§€ì •.

---

## 3. app/ - âœï¸ ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜

### `app/__init__.py`
ë¹ˆ íŒŒì¼. `app` ë””ë ‰í† ë¦¬ë¥¼ Python íŒ¨í‚¤ì§€ë¡œ ì¸ì‹ì‹œí‚´.

### âœï¸ `app/main.py` - FastAPI ì•± ì§„ì…ì 
**í”„ë¡œì íŠ¸ì˜ ê°€ì¥ í•µì‹¬ì ì¸ íŒŒì¼.** ì•± ì‹œì‘/ì¢…ë£Œ ì „ì²´ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬.

**ì—­í• :**
1. **FastAPI ì•± ìƒì„±**: ì œëª©, ë²„ì „, ë¼ì´í”„ì‚¬ì´í´ ë“±ë¡
2. **âœï¸ ë¼ì´í”„ì‚¬ì´í´(lifespan)**: ì•± ì‹œì‘ ì‹œ í•„ìš”í•œ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì´ˆê¸°í™”
   - ë¡œê¹… ì„¤ì • (`setup_logging`)
   - ìŠ¤ë ˆë“œ í’€ ì„¤ì • (`ThreadPoolExecutor`)
   - ì•”í˜¸í™” ë§¤ë‹ˆì € (`EncryptionManager`) ì´ˆê¸°í™”
   - ì¸ì¦ ì„œë¹„ìŠ¤ (`AuthService`) + ì„¸ì…˜ ë§¤ë‹ˆì € (`SessionManager`) ì´ˆê¸°í™”
   - **ğŸ†• ì´ˆê¸° ê´€ë¦¬ì ê³„ì • ìë™ ìƒì„±** (`bootstrap_admin`): ìµœì´ˆ ê¸°ë™ ì‹œ `INITIAL_ADMIN_*` í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬ì ìƒì„±
   - íŠ¸ë ˆì´ë”© ì—”ì§„ (`TradingEngine`) ì‹œì‘ - ëª¨ë“  í™œì„± ê³„ì •ì˜ ìë™ë§¤ë§¤ ì‹œì‘
   - **ğŸ†• ìº”ë“¤ ì§‘ê³„ ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬** (`CandleAggregator`) ì‹œì‘
   - **ğŸ†• ê³ ì•„ ë°±í…ŒìŠ¤íŠ¸ ì •ë¦¬** (`cleanup_orphan_backtests`): ì‹œì‘ ì‹œ RUNNING ìƒíƒœë¡œ ë‚¨ì€ ë°±í…ŒìŠ¤íŠ¸ ì •ë¦¬
3. **ë¯¸ë“¤ì›¨ì–´ ë“±ë¡**:
   - `CSRFMiddleware`: SSR í¼ POST ìš”ì²­ì— CSRF í† í° ìš”êµ¬
   - **âœï¸ `LazyAuthMiddleware`**: ì¿ í‚¤ì—ì„œ ë¡œì»¬ DB ì„¸ì…˜ í† í° ì¶”ì¶œ â†’ `request.state.user`ì— ì£¼ì…
4. **âœï¸ ë¼ìš°í„° ë“±ë¡**: 8ê°œ API ë¼ìš°í„° + 1ê°œ SSR í˜ì´ì§€ ë¼ìš°í„° (`combos_router`, `backtest_router` ì¶”ê°€)
5. **ì •ì  íŒŒì¼ ì„œë¹™**: CSS, JS íŒŒì¼ì„ `/static` ê²½ë¡œë¡œ ì„œë¹™

**âœï¸ `LazyAuthMiddleware`** ë‚´ë¶€ ë™ì‘:
- ê³µê°œ ê²½ë¡œ(`/health`, `/login`, `/api/auth/*`, `/static`)ëŠ” ì¸ì¦ ì—†ì´ í†µê³¼
- ë‚˜ë¨¸ì§€ ê²½ë¡œ: ì¿ í‚¤ì—ì„œ ì„¸ì…˜ í† í° ì¶”ì¶œ â†’ **ë¡œì»¬ DBì—ì„œ uid/email/role ê²€ì¦** â†’ `request.state.user`ì— ì£¼ì…
- ì¸ì¦ ì‹¤íŒ¨ ì‹œ: API ìš”ì²­ì´ë©´ 401 ë°˜í™˜, í˜ì´ì§€ ìš”ì²­ì´ë©´ `/login`ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

### âœï¸ `app/config.py` - ê¸€ë¡œë²Œ ì„¤ì •
`pydantic-settings`ì˜ `BaseSettings`ë¥¼ ìƒì†í•˜ì—¬ `.env` íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ìë™ ë¡œë”©.

**âœï¸ ì£¼ìš” í•„ë“œ:**
- `database_url`: PostgreSQL ì§ì ‘ ì—°ê²° (íŠ¸ë ˆì´ë”© ì—”ì§„ìš©)
- `encryption_keys`: ì‰¼í‘œ êµ¬ë¶„ ë‹¤ì¤‘ Fernet í‚¤ ë¬¸ìì—´
- `session_secret_key`, `csrf_secret`: ì„¸ì…˜/CSRF ì‹œí¬ë¦¿
- `api_rate_limit`: ë°”ì´ë‚¸ìŠ¤ API ë¶„ë‹¹ ê°€ì¤‘ì¹˜ í•œë„ (ê¸°ë³¸ 1000)
- `thread_pool_size`: `asyncio.to_thread` í’€ í¬ê¸° (ê¸°ë³¸ 20)
- **ğŸ†•** `initial_admin_email`, `initial_admin_password`: ìµœì´ˆ ê´€ë¦¬ì ìë™ ìƒì„±ìš©

> âŒ ì œê±°ë¨: `supabase_url`, `supabase_anon_key`, `supabase_service_role_key`

**íŠ¹ìˆ˜ í”„ë¡œí¼í‹°:**
- `encryption_key_list`: ì‰¼í‘œë¡œ êµ¬ë¶„ëœ `encryption_keys` ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜

### `app/dependencies.py` - FastAPI ì˜ì¡´ì„± ì£¼ì…
FastAPIì˜ `Depends()` ì‹œìŠ¤í…œì— ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜ë“¤. ë¼ìš°í„° í•¸ë“¤ëŸ¬ê°€ í•„ìš”í•œ ê°ì²´ë¥¼ ìë™ìœ¼ë¡œ ì£¼ì…ë°›ìŒ.

**ì œê³µí•˜ëŠ” ì˜ì¡´ì„±:**
- `get_db()`: DB ì„¸ì…˜ (SQLAlchemy AsyncSession)
- `get_trading_engine()`: íŠ¸ë ˆì´ë”© ì—”ì§„ (app.stateì—ì„œ ê°€ì ¸ì˜´)
- `get_current_user()`: í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ì (ë¯¸ì¸ì¦ ì‹œ 401)
- `require_admin()`: ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ë¹„ê´€ë¦¬ì ì‹œ 403)
- `get_auth_service()`: ì¸ì¦ ì„œë¹„ìŠ¤
- `get_session_manager()`: ì„¸ì…˜ ë§¤ë‹ˆì €
- `get_encryption()`: ì•”í˜¸í™” ë§¤ë‹ˆì €

---

## 4. âœï¸ app/models/ - ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸

SQLAlchemy 2.0ì˜ ì„ ì–¸ì  ë§¤í•‘(`DeclarativeBase`)ì„ ì‚¬ìš©. ê° íŒŒì¼ì´ í•˜ë‚˜ì˜ DB í…Œì´ë¸”ì— ëŒ€ì‘.

### `app/models/base.py` - ë² ì´ìŠ¤ í´ë˜ìŠ¤
ëª¨ë“  ëª¨ë¸ì´ ìƒì†í•˜ëŠ” SQLAlchemy `Base` í´ë˜ìŠ¤ ì •ì˜.

### âœï¸ `app/models/user.py` - ì‚¬ìš©ì í”„ë¡œí•„ (`user_profiles` í…Œì´ë¸”)
ë¡œì»¬ DB ì¸ì¦ìœ¼ë¡œ ë“±ë¡ëœ ì‚¬ìš©ì ì •ë³´.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|-------|------|------|
| `id` | UUID (PK) | ì‚¬ìš©ì ê³ ìœ  ID |
| `email` | String | ì´ë©”ì¼ (ë¡œê·¸ì¸ ì‹ë³„ì) |
| `password_hash` | String | bcrypt í•´ì‹œ ë¹„ë°€ë²ˆí˜¸ |
| `display_name` | String (nullable) | í‘œì‹œ ì´ë¦„ |
| `role` | String | ì—­í• : `"user"` ë˜ëŠ” `"admin"` |
| `created_at` | Timestamp | ìƒì„± ì‹œê° |

**ê´€ê³„:** `accounts` â†’ ì´ ì‚¬ìš©ìê°€ ì†Œìœ í•œ íŠ¸ë ˆì´ë”© ê³„ì • ëª©ë¡

### âœï¸ `app/models/account.py` - íŠ¸ë ˆì´ë”© ê³„ì • (`trading_accounts` í…Œì´ë¸”)
**ì‹œìŠ¤í…œì˜ í•µì‹¬ ë‹¨ìœ„.** í•˜ë‚˜ì˜ ë°”ì´ë‚¸ìŠ¤ API í‚¤ + ë§¤ë§¤ ì„¤ì • ë¬¶ìŒ.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|-------|------|------|
| `id` | UUID (PK) | ê³„ì • ê³ ìœ  ID |
| `owner_id` | UUID (FKâ†’user_profiles) | ì†Œìœ ì |
| `name` | String | ê³„ì • ë³„ëª… (ì˜ˆ: "ë©”ì¸ê³„ì •", "í…ŒìŠ¤íŠ¸") |
| `exchange` | String | ê±°ë˜ì†Œ ì¢…ë¥˜ (ê¸°ë³¸: "binance") |
| `symbol` | String | ë§¤ë§¤ ëŒ€ìƒ ì‹¬ë³¼ (ì˜ˆ: "BTCUSDT", "ETHUSDT") |
| `base_asset` / `quote_asset` | String | ê¸°ì´ˆ/ì¸ìš© ìì‚° (ì˜ˆ: "BTC"/"USDT") |
| `api_key_encrypted` | String | **ì•”í˜¸í™”ëœ** ë°”ì´ë‚¸ìŠ¤ API í‚¤ |
| `api_secret_encrypted` | String | **ì•”í˜¸í™”ëœ** ë°”ì´ë‚¸ìŠ¤ API ì‹œí¬ë¦¿ |
| `encryption_key_version` | Integer | ì•”í˜¸í™” í‚¤ ë²„ì „ (í‚¤ ë¡œí…Œì´ì…˜ìš©) |
| `is_active` | Boolean | ë§¤ë§¤ í™œì„± ìƒíƒœ |
| `circuit_breaker_failures` | Integer | ì—°ì† ì‹¤íŒ¨ íšŸìˆ˜ |
| `circuit_breaker_disabled_at` | Timestamp | ì„œí‚· ë¸Œë ˆì´ì»¤ ë°œë™ ì‹œê° |
| `last_success_at` | Timestamp | ë§ˆì§€ë§‰ ì„±ê³µ ì‹œê° |
| `loop_interval_sec` | Integer | ë§¤ë§¤ ë£¨í”„ ì£¼ê¸° (ê¸°ë³¸ 60ì´ˆ) |
| `order_cooldown_sec` | Integer | ì£¼ë¬¸ ê°„ ìµœì†Œ ëŒ€ê¸° (ê¸°ë³¸ 7ì´ˆ) |
| **ğŸ†•** `buy_pause_state` | String (Enum) | Buy Pause ìƒíƒœ: `ACTIVE` / `THROTTLED` / `PAUSED` |
| **ğŸ†•** `buy_pause_reason` | String (nullable) | ì¼ì‹œì •ì§€ ì‚¬ìœ  |
| **ğŸ†•** `buy_pause_since` | Timestamp (nullable) | ì¼ì‹œì •ì§€ ì‹œì‘ ì‹œê° |
| **ğŸ†•** `consecutive_low_balance` | Integer | ì—°ì† ì”ê³  ë¶€ì¡± íšŸìˆ˜ |

**ê´€ê³„:** `strategy_states`, `orders`, `fills`, `lots`, `positions`, **ğŸ†•** `trading_combos`

**ì„¤ê³„ í¬ì¸íŠ¸:**
- API í‚¤ëŠ” **ì ˆëŒ€ í‰ë¬¸ ì €ì¥í•˜ì§€ ì•ŠìŒ**. MultiFernetìœ¼ë¡œ ì•”í˜¸í™” í›„ ì €ì¥
- ì„œí‚· ë¸Œë ˆì´ì»¤: ì—°ì† 5íšŒ ì‹¤íŒ¨ ì‹œ `is_active=false`ë¡œ ì „í™˜, ê´€ë¦¬ìê°€ ìˆ˜ë™ ë¦¬ì…‹
- **ğŸ†• `BuyPauseState` enum**: `ACTIVE` â†’ `THROTTLED`(ë£¨í”„ ì§€ì—°) â†’ `PAUSED`(ë§¤ìˆ˜ ì¤‘ë‹¨) ìƒíƒœ ê¸°ê³„

### âŒ `app/models/strategy_config.py` - ì „ëµ ì„¤ì • (deprecated)
~~ê³„ì •ë³„ë¡œ ì–´ë–¤ ì „ëµì„ ì‚¬ìš©í•˜ê³ , ì–´ë–¤ íŒŒë¼ë¯¸í„°ë¡œ ìš´ì˜í•˜ëŠ”ì§€ ì •ì˜.~~

**deprecated**: `TradingCombo`ë¡œ ëŒ€ì²´ë¨. í…Œì´ë¸”ì€ ìœ ì§€ë˜ë‚˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ.
ê¸°ì¡´ ë°ì´í„°ëŠ” `scripts/migrate_strategy_to_combo.py`ë¡œ ì´ê´€.

### ğŸ†• `app/models/trading_combo.py` - íŠ¸ë ˆì´ë”© ì½¤ë³´ (`trading_combos` í…Œì´ë¸”)
Buy Logic + Sell Logic ì¡°í•© ë‹¨ìœ„. í•˜ë‚˜ì˜ ê³„ì •ì— ì—¬ëŸ¬ ì½¤ë³´ë¥¼ ë™ì‹œ ìš´ì˜ ê°€ëŠ¥.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|-------|------|------|
| `id` | UUID (PK) | ì½¤ë³´ ê³ ìœ  ID |
| `account_id` | UUID (FK) | ì†Œì† ê³„ì • |
| `name` | String | ì½¤ë³´ ì´ë¦„ (ì˜ˆ: "lot+fixedtp") |
| `buy_logic_name` | String | Buy Logic ì´ë¦„ (ì˜ˆ: "lot_stacking") |
| `sell_logic_name` | String | Sell Logic ì´ë¦„ (ì˜ˆ: "fixed_tp") |
| `buy_params` | JSONB | Buy Logic íŒŒë¼ë¯¸í„° |
| `sell_params` | JSONB | Sell Logic íŒŒë¼ë¯¸í„° |
| `reference_combo_id` | UUID (nullable) | ì°¸ì¡° ì½¤ë³´ ID (êµì°¨ ìŠ¤ì½”í”„ ì°¸ì¡°ìš©) |
| `is_enabled` | Boolean | ì½¤ë³´ í™œì„±í™” ì—¬ë¶€ |

### ğŸ†• `app/models/backtest_run.py` - ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê¸°ë¡ (`backtest_runs` í…Œì´ë¸”)
ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìš”ì²­ê³¼ ê²°ê³¼ë¥¼ ì˜ì†ì ìœ¼ë¡œ ì €ì¥.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|-------|------|------|
| `id` | UUID (PK) | ì‹¤í–‰ ê³ ìœ  ID |
| `user_id` | UUID (FK) | ìš”ì²­í•œ ì‚¬ìš©ì |
| `symbol` | String | ë°±í…ŒìŠ¤íŠ¸ ì‹¬ë³¼ |
| `combos` | JSONB | ì½¤ë³´ ì„¤ì • ìŠ¤ëƒ…ìƒ· (ì‹¤í–‰ ì‹œì ) |
| `initial_usdt` | Float | ì´ˆê¸° USDT ìê¸ˆ |
| `start_ts_ms` / `end_ts_ms` | BigInt | ë°±í…ŒìŠ¤íŠ¸ ê¸°ê°„ (ë°€ë¦¬ì´ˆ) |
| `status` | String | `PENDING` / `RUNNING` / `DONE` / `FAILED` |
| `result_summary` | JSONB (nullable) | ìˆ˜ìµë¥ , ê±°ë˜ íšŸìˆ˜ ë“± ìš”ì•½ |
| `trade_log` | JSONB (nullable) | ê°œë³„ ê±°ë˜ ë‚´ì—­ |
| `equity_curve` | JSONB (nullable) | ìì‚° ë³€ë™ ê³¡ì„  |

### `app/models/strategy_state.py` - ì „ëµ ìƒíƒœ í‚¤-ê°’ (`strategy_state` í…Œì´ë¸”)
ì „ëµì´ ë§¤ë§¤ ì¤‘ ìœ ì§€í•´ì•¼ í•˜ëŠ” ìƒíƒœê°’ì„ ì €ì¥í•˜ëŠ” **í‚¤-ê°’(Key-Value) ì €ì¥ì†Œ**.

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|-------|------|------|
| `account_id` | UUID (PK) | ê³„ì • |
| `scope` | String (PK) | **âœï¸ ë²”ìœ„: ì½¤ë³´ ID ë¬¸ìì—´** (ì´ì „ì—ëŠ” ì „ëµ ì´ë¦„) |
| `key` | String (PK) | ìƒíƒœ í‚¤ ì´ë¦„ |
| `value` | String | ìƒíƒœ ê°’ |

**3ì¤‘ PK:** `(account_id, scope, key)` â†’ ê³„ì •ë³„, ì½¤ë³´ë³„ë¡œ ìƒíƒœê°€ ì™„ì „íˆ ê²©ë¦¬ë¨

### `app/models/order.py` - ì£¼ë¬¸ (`orders` í…Œì´ë¸”)
ë°”ì´ë‚¸ìŠ¤ì— ì œì¶œëœ ì£¼ë¬¸ ì •ë³´. ê±°ë˜ì†Œ API ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ì €ì¥.

| ì£¼ìš” ì»¬ëŸ¼ | ì„¤ëª… |
|-----------|------|
| `order_id` + `account_id` | ë³µí•© PK (ê±°ë˜ì†Œ ì£¼ë¬¸ ID + ê³„ì •) |
| `symbol`, `side`, `type` | ì‹¬ë³¼, ë§¤ìˆ˜/ë§¤ë„, ì£¼ë¬¸ ìœ í˜• |
| `status` | ì£¼ë¬¸ ìƒíƒœ: NEW, FILLED, CANCELED ë“± |
| `price`, `orig_qty`, `executed_qty` | ê°€ê²©, ì›ë˜ ìˆ˜ëŸ‰, ì²´ê²° ìˆ˜ëŸ‰ |
| `raw_json` | ê±°ë˜ì†Œ API ì›ë³¸ ì‘ë‹µ (JSONB) |

### `app/models/fill.py` - ì²´ê²° (`fills` í…Œì´ë¸”)
ì‹¤ì œ ì²´ê²°(Trade) ê¸°ë¡. í•˜ë‚˜ì˜ ì£¼ë¬¸ì´ ì—¬ëŸ¬ ì²´ê²°ë¡œ ë‚˜ë‰  ìˆ˜ ìˆìŒ.

| ì£¼ìš” ì»¬ëŸ¼ | ì„¤ëª… |
|-----------|------|
| `trade_id` + `account_id` | ë³µí•© PK |
| `order_id` | ì†Œì† ì£¼ë¬¸ |
| `price`, `qty`, `quote_qty` | ì²´ê²° ê°€ê²©, ìˆ˜ëŸ‰, USDT ê¸ˆì•¡ |
| `commission`, `commission_asset` | ìˆ˜ìˆ˜ë£Œ |

### `app/models/lot.py` - ë¡œíŠ¸ (`lots` í…Œì´ë¸”)
**ë§¤ìˆ˜ ë¬¶ìŒ ë‹¨ìœ„.** Buy Logicì´ ê³µí†µìœ¼ë¡œ ì‚¬ìš©.

| ì£¼ìš” ì»¬ëŸ¼ | ì„¤ëª… |
|-----------|------|
| `lot_id` + `account_id` | ë³µí•© PK |
| `strategy_name` | Buy Logic ì´ë¦„ (ì˜ˆ: "lot_stacking") |
| `buy_price`, `buy_qty` | ë§¤ìˆ˜ ê°€ê²©/ìˆ˜ëŸ‰ |
| `status` | `"OPEN"` ë˜ëŠ” `"CLOSED"` |
| `sell_order_id`, `sell_price` | ë§¤ë„ ì£¼ë¬¸ ì •ë³´ |
| `net_profit_usdt` | ìˆœì´ìµ |
| `metadata_` | JSONB í™•ì¥ í•„ë“œ |

### `app/models/position.py` - í¬ì§€ì…˜ (`positions` í…Œì´ë¸”)
ê³„ì •+ì‹¬ë³¼ë³„ ì´ ë³´ìœ  í˜„í™©. Fill(ì²´ê²°) ê¸°ë¡ìœ¼ë¡œë¶€í„° ì¬ê³„ì‚°ë¨.

| ì»¬ëŸ¼ | ì„¤ëª… |
|-------|------|
| `account_id` + `symbol` | ë³µí•© PK |
| `qty` | ì´ ë³´ìœ  ìˆ˜ëŸ‰ |
| `cost_basis_usdt` | ì´ ì›ê°€ |
| `avg_entry` | í‰ê·  ë§¤ì…ê°€ |

### âŒ `app/models/price_snapshot.py` - ê°€ê²© ìŠ¤ëƒ…ìƒ· (deprecated)
~~5ë¶„ ê°„ê²©ìœ¼ë¡œ ê¸°ë¡ë˜ëŠ” ê°€ê²© ìŠ¤ëƒ…ìƒ·.~~

**deprecated**: ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë” ì´ìƒ writeí•˜ì§€ ì•ŠìŒ. ìº”ë“¤ í…Œì´ë¸”ë¡œ ëŒ€ì²´ë¨.

### âœï¸ `app/models/price_candle.py` - ìº”ë“¤ ë°ì´í„° (4ê°œ í…Œì´ë¸”)
OHLCV ìº”ë“¤ ë°ì´í„°. íƒ€ì„í”„ë ˆì„ë³„ë¡œ ë³„ë„ í…Œì´ë¸”.

| í´ë˜ìŠ¤ | í…Œì´ë¸” | ì„¤ëª… |
|--------|--------|------|
| `PriceCandle5m` | `price_candles_5m` | 5ë¶„ë´‰. âœï¸ volume / quote_volume / trade_count ì¶”ê°€ |
| **ğŸ†•** `PriceCandle1m` | `price_candles_1m` | 1ë¶„ë´‰. WebSocketì—ì„œ ì§ì ‘ ìˆ˜ì‹  |
| **ğŸ†•** `PriceCandle1h` | `price_candles_1h` | 1ì‹œê°„ë´‰. 5m ì§‘ê³„ |
| **ğŸ†•** `PriceCandle1d` | `price_candles_1d` | ì¼ë´‰. 1h ì§‘ê³„ |

ê³µí†µ ì»¬ëŸ¼: `symbol`, `ts_ms` (ìœ ë‹ˆí¬ ì¸ë±ìŠ¤), `open`, `high`, `low`, `close`, `volume`, `quote_volume`, `trade_count`

### `app/models/core_btc_history.py` - ì½”ì–´ BTC ì´ë ¥ (`core_btc_history` í…Œì´ë¸”)
ë¦¬ì €ë¸Œ í’€(reserve pool) ë³€ë™ ì´ë ¥.

---

## 5. âœï¸ app/db/ - ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê³„ì¸µ

### âœï¸ `app/db/session.py` - DB ì„¸ì…˜ ê´€ë¦¬
**ì´ì¤‘ ì—°ê²° ì „ëµ**ì˜ í•µì‹¬.

**`engine_trading`** (SQLAlchemy ì§ì ‘ ì—°ê²°):
- íŠ¸ë ˆì´ë”© ì—”ì§„ì´ ì‚¬ìš©. ëª¨ë“  ê³„ì • ë°ì´í„°ì— ì§ì ‘ ì ‘ê·¼
- **âœï¸ `pool_size=30`** (WS ë§¤ë‹ˆì € ì„¸ì…˜ ì¦ê°€ë¡œ 20â†’30ìœ¼ë¡œ í™•ì¥), `max_overflow=10`

**`TradingSessionLocal`** (ì„¸ì…˜ íŒ©í† ë¦¬):
- `AsyncSession`ì„ ìƒì„±í•˜ëŠ” íŒ©í† ë¦¬. `expire_on_commit=False`ë¡œ ì„¤ì •

**`get_trading_session()`**:
- FastAPI ë¼ìš°í„°ì—ì„œ `Depends(get_trading_session)`ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” DB ì„¸ì…˜ ì œë„ˆë ˆì´í„°

### `app/db/repository.py` - ë² ì´ìŠ¤ ë¦¬í¬ì§€í† ë¦¬
ì œë„¤ë¦­ CRUD ë² ì´ìŠ¤. `get_by_id()`, `create()`, `delete_by_id()` ê³µí†µ ë©”ì„œë“œ ì œê³µ.

### `app/db/account_repo.py` - ê³„ì • ë¦¬í¬ì§€í† ë¦¬
`TradingAccount` ëª¨ë¸ ì „ìš© ë°ì´í„° ì ‘ê·¼.

**ì£¼ìš” ë©”ì„œë“œ:**
- `get_by_id(account_id)`: ê³„ì • ì¡°íšŒ
- `get_active_accounts()`: í™œì„±(`is_active=True`) ê³„ì • ëª©ë¡
- `get_by_owner(owner_id)`: íŠ¹ì • ì‚¬ìš©ìì˜ ê³„ì • ëª©ë¡
- `create(account)`: ê³„ì • ìƒì„±
- `update_circuit_breaker(account_id, failures, disabled_at)`: ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœ ì—…ë°ì´íŠ¸
- `reset_circuit_breaker(account_id)`: ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹ (ê´€ë¦¬ììš©)
- `update_last_success(account_id)`: ë§ˆì§€ë§‰ ì„±ê³µ ì‹œê° ê°±ì‹ 

### âœï¸ `app/db/lot_repo.py` - ë¡œíŠ¸ ë¦¬í¬ì§€í† ë¦¬
`Lot` ëª¨ë¸ ì „ìš©.

**ì£¼ìš” ë©”ì„œë“œ:**
- `get_open_lots(account_id, symbol, strategy_name)`: ì—´ë¦° ë¡œíŠ¸ ëª©ë¡
- **ğŸ†•** `get_open_lots_by_combo(account_id, symbol, combo_id)`: ì½¤ë³´ ID ê¸°ì¤€ ì—´ë¦° ë¡œíŠ¸ ì¡°íšŒ
- `insert_lot(...)`: ìƒˆ ë¡œíŠ¸ ìƒì„±
- `close_lot(lot_id, account_id, ...)`: ë¡œíŠ¸ ë‹«ê¸°
- `set_sell_order(lot_id, account_id, sell_order_id)`: ìµì ˆ ì£¼ë¬¸ ID ì—°ê²°
- `clear_sell_order(lot_id, account_id)`: ìµì ˆ ì£¼ë¬¸ ì´ˆê¸°í™”

### `app/db/order_repo.py` - ì£¼ë¬¸ ë¦¬í¬ì§€í† ë¦¬
`Order` + `Fill` ëª¨ë¸.

**ì£¼ìš” ë©”ì„œë“œ:**
- `upsert_order(account_id, order_data)`: PostgreSQL UPSERTë¡œ ì£¼ë¬¸ ì •ë³´ ê°±ì‹ 
- `get_order(order_id, account_id)`: ì£¼ë¬¸ ì¡°íšŒ
- `get_recent_open_orders(account_id)`: ë¯¸ì²´ê²° ì£¼ë¬¸ ID ëª©ë¡
- `insert_fill(account_id, order_id, trade_data)`: ì²´ê²° ê¸°ë¡ ì‚½ì…

### `app/db/position_repo.py` - í¬ì§€ì…˜ ë¦¬í¬ì§€í† ë¦¬
**ì£¼ìš” ë©”ì„œë“œ:**
- `get(account_id, symbol)`: í¬ì§€ì…˜ ì¡°íšŒ
- `upsert(account_id, symbol, qty, cost_basis_usdt, avg_entry)`: í¬ì§€ì…˜ ê°±ì‹ 
- `recompute_from_fills(account_id, symbol)`: ì²´ê²° ê¸°ë¡ìœ¼ë¡œë¶€í„° í¬ì§€ì…˜ ì¬ê³„ì‚°

### âœï¸ `app/db/price_repo.py` - ê°€ê²© ë°ì´í„° ë¦¬í¬ì§€í† ë¦¬
**ëª¨ë“ˆ ë ˆë²¨ í•¨ìˆ˜** (í´ë˜ìŠ¤ ì—†ìŒ). ìº”ë“¤ ë°ì´í„° ì €ì¥/ì¡°íšŒ.

**âœï¸ ì£¼ìš” í•¨ìˆ˜:**
- **âœï¸** `get_candles(symbol, from_ms, to_ms, session, interval)`: ìº”ë“¤ ì¡°íšŒ. `interval` íŒŒë¼ë¯¸í„°ë¡œ 1m/5m/1h/1d ì„ íƒ. ë‚´ë¶€ì ìœ¼ë¡œ `_TABLE_MAP`ìœ¼ë¡œ í…Œì´ë¸” ì„ íƒ
- `upsert_candle_5m(symbol, ts_ms, price, session)`: 5ë¶„ë´‰ ìº”ë“¤ upsert

> âŒ ì œê±°ë¨: `insert_snapshot()`, `get_snapshots()` (price_snapshot deprecatedì— ë”°ë¼ ì‚­ì œ)

### `app/db/strategy_state_repo.py` - ì „ëµ ìƒíƒœ ë¦¬í¬ì§€í† ë¦¬
`StrategyStateStore` í´ë˜ìŠ¤ë¥¼ ì¬ìˆ˜ì¶œí•˜ê³ , ì¶”ê°€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì œê³µ.

- `get_all_for_account(account_id, session)`: ê³„ì •ì˜ ëª¨ë“  ì „ëµ ìƒíƒœë¥¼ í•œ ë²ˆì— ì¡°íšŒ

---

## 6. app/exchange/ - ê±°ë˜ì†Œ í´ë¼ì´ì–¸íŠ¸

### `app/exchange/base_client.py` - ê±°ë˜ì†Œ í´ë¼ì´ì–¸íŠ¸ ì¶”ìƒ ì¸í„°í˜ì´ìŠ¤
ëª¨ë“  ê±°ë˜ì†Œ í´ë¼ì´ì–¸íŠ¸ê°€ êµ¬í˜„í•´ì•¼ í•˜ëŠ” **ì¶”ìƒ í´ë˜ìŠ¤(ABC)**.

**`SymbolFilters` ë°ì´í„°í´ë˜ìŠ¤:**
- `step_size`: ìˆ˜ëŸ‰ ìµœì†Œ ë‹¨ìœ„ (ì˜ˆ: 0.00001 BTC)
- `tick_size`: ê°€ê²© ìµœì†Œ ë‹¨ìœ„ (ì˜ˆ: 0.01 USDT)
- `min_notional`: ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡

**12ê°œ ì¶”ìƒ ë©”ì„œë“œ:**
| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `get_price(symbol)` | í˜„ì¬ê°€ ì¡°íšŒ |
| `get_symbol_filters(symbol)` | ì‹¬ë³¼ í•„í„°(ìµœì†Œë‹¨ìœ„) ì¡°íšŒ |
| `adjust_qty(qty, symbol)` | ìˆ˜ëŸ‰ì„ step_sizeì— ë§ê²Œ ë‚´ë¦¼ |
| `adjust_price(price, symbol)` | ê°€ê²©ì„ tick_sizeì— ë§ê²Œ ë‚´ë¦¼ |
| `get_open_orders(symbol)` | ë¯¸ì²´ê²° ì£¼ë¬¸ ëª©ë¡ |
| `get_order(order_id, symbol)` | ì£¼ë¬¸ ìƒì„¸ ì¡°íšŒ |
| `cancel_order(order_id, symbol)` | ì£¼ë¬¸ ì·¨ì†Œ |
| `get_my_trades(symbol, limit, order_id)` | ì²´ê²° ë‚´ì—­ ì¡°íšŒ |
| `place_limit_sell(qty, price, symbol)` | ì§€ì •ê°€ ë§¤ë„ |
| `place_limit_buy_by_quote(quote_usdt, price, symbol)` | USDT ê¸ˆì•¡ ê¸°ì¤€ ì§€ì •ê°€ ë§¤ìˆ˜ |
| `get_balance(asset)` | ìì‚° ì”ê³  ì¡°íšŒ |
| `get_free_balance(asset)` | ì‚¬ìš© ê°€ëŠ¥ ì”ê³  ì¡°íšŒ |

### `app/exchange/binance_client.py` - ë°”ì´ë‚¸ìŠ¤ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸
`ExchangeClient`ë¥¼ êµ¬í˜„í•œ ì‹¤ì œ ë°”ì´ë‚¸ìŠ¤ ì—°ë™ í´ë¼ì´ì–¸íŠ¸.

**í•µì‹¬ ì„¤ê³„: ë™ê¸° ì½”ì–´ + ë¹„ë™ê¸° ë˜í¼**

`python-binance` ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ë™ê¸°(sync) ë°©ì‹ì´ë¯€ë¡œ, ëª¨ë“  ë©”ì„œë“œë¥¼ `asyncio.to_thread`ë¡œ ë˜í•‘í•˜ì—¬ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë¸”ë¡œí‚¹í•˜ì§€ ì•ŠìŒ.

**ì‹¬ë³¼ í•„í„° ìºì‹œ:** `_filters_cache`ë¡œ í•œ ë²ˆ ì¡°íšŒí•œ ì‹¬ë³¼ì˜ step_size/tick_sizeë¥¼ ìºì‹œí•˜ì—¬ ë°˜ë³µ API í˜¸ì¶œ ë°©ì§€.

### `app/exchange/backtest_client.py` - ë°±í…ŒìŠ¤íŠ¸ìš© ê°€ìƒ í´ë¼ì´ì–¸íŠ¸
`ExchangeClient`ë¥¼ êµ¬í˜„í•œ **ì‹œë®¬ë ˆì´ì…˜ í´ë¼ì´ì–¸íŠ¸**. ì‹¤ì œ API í˜¸ì¶œ ì—†ì´ ë©”ëª¨ë¦¬ì—ì„œ ê±°ë˜ë¥¼ ì‹œë®¬ë ˆì´ì…˜.

**ë™ì‘ ë°©ì‹:**
1. `set_price(price)` í˜¸ì¶œë¡œ í˜„ì¬ ì‹œë®¬ë ˆì´ì…˜ ê°€ê²© ì„¤ì •
2. ê°€ê²© ì„¤ì • ì‹œ ìë™ìœ¼ë¡œ `_check_order_fills()` í˜¸ì¶œ â†’ ëŒ€ê¸° ì¤‘ì¸ ì§€ì •ê°€ ì£¼ë¬¸ ì²´ê²° í™•ì¸
3. ì”ê³ , ì£¼ë¬¸, ì²´ê²° ë‚´ì—­ì„ ëª¨ë‘ ë©”ëª¨ë¦¬ì—ì„œ ê´€ë¦¬

---

## 7. âœï¸ app/strategies/ - ë§¤ë§¤ ì „ëµ í”ŒëŸ¬ê·¸ì¸

ì „ëµ ì‹œìŠ¤í…œì´ **Buy Logic / Sell Logic ë¶„ë¦¬ êµ¬ì¡°**ë¡œ ì¬ì„¤ê³„ë¨.
ì´ì „ì˜ ë‹¨ì¼ `BaseStrategy` ëŒ€ì‹  `BaseBuyLogic`ê³¼ `BaseSellLogic`ì„ ë³„ë„ë¡œ êµ¬í˜„í•˜ê³ ,
ì´ë¥¼ `TradingCombo`ë¡œ ì¡°í•©í•˜ì—¬ ìš´ì˜.

### âœï¸ `app/strategies/base.py` - ì „ëµ ë² ì´ìŠ¤ í´ë˜ìŠ¤
**âœï¸ `StrategyContext` ë°ì´í„°í´ë˜ìŠ¤** - ë§¤ tickë§ˆë‹¤ ì „ëµì— ì „ë‹¬ë˜ëŠ” ë¶ˆë³€ ì»¨í…ìŠ¤íŠ¸:
- `account_id`: ê³„ì • ID
- `symbol`: ë§¤ë§¤ ì‹¬ë³¼
- `current_price`: í˜„ì¬ ê°€ê²©
- `params`: ì „ëµ íŒŒë¼ë¯¸í„°
- **âœï¸** `client_order_prefix`: ì£¼ë¬¸ ID ì ‘ë‘ì–´ (ê³„ì •+ì½¤ë³´ ì‹ë³„ìš©)

**`RepositoryBundle` ë°ì´í„°í´ë˜ìŠ¤** - DB ë¦¬í¬ì§€í† ë¦¬ ë¬¶ìŒ:
- `lot`, `order`, `position`, `price`

**âœï¸ ì¶”ìƒ í´ë˜ìŠ¤ ë¶„ë¦¬:**

`BaseBuyLogic`:
- `pre_tick(ctx, state, exchange, account_state, repos)`: tick ì „ ì „ì²˜ë¦¬ (ëŒ€ê¸° ì£¼ë¬¸ í™•ì¸ ë“±)
- `tick(ctx, state, exchange, account_state, repos)`: **ë©”ì¸ ë§¤ìˆ˜ ì‚¬ì´í´**

`BaseSellLogic`:
- `tick(ctx, state, exchange, account_state, repos, buy_lots)`: **ë©”ì¸ ë§¤ë„ ì‚¬ì´í´**

> âŒ ì œê±°ë¨: ë‹¨ì¼ `BaseStrategy` í´ë˜ìŠ¤ (BaseBuyLogic + BaseSellLogicìœ¼ë¡œ ë¶„ë¦¬)

### âœï¸ `app/strategies/state_store.py` - ì „ëµ ìƒíƒœ ì €ì¥ì†Œ
`strategy_state` í…Œì´ë¸”ì„ key-value ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ” ë˜í¼.

**âœï¸ scope**: ì´ì „ì—ëŠ” ì „ëµ ì´ë¦„(`"lot_stacking"` ë“±). **í˜„ì¬ëŠ” ì½¤ë³´ ID ë¬¸ìì—´**ë¡œ ê²©ë¦¬ë¨.

**ì£¼ìš” ë©”ì„œë“œ:** `get(key)` / `set(key, value)`, `get_float(key)` / `get_int(key)`, `delete(key)`, `clear_keys(*keys)`, `get_all()`

### âœï¸ `app/strategies/registry.py` - ì „ëµ ë ˆì§€ìŠ¤íŠ¸ë¦¬
**âœï¸ `BuyLogicRegistry`** + **`SellLogicRegistry`** (ê¸°ì¡´ ë‹¨ì¼ `StrategyRegistry`ì—ì„œ ë¶„ë¦¬)

```python
@BuyLogicRegistry.register
class LotStackingBuy(BaseBuyLogic):
    name = "lot_stacking"

@SellLogicRegistry.register
class FixedTpSell(BaseSellLogic):
    name = "fixed_tp"
```

### ğŸ†• `app/strategies/buys/` - Buy Logic êµ¬í˜„ì²´

#### ğŸ†• `app/strategies/buys/lot_stacking.py` - LotStackingBuy
**ë¶„í•  ë§¤ìˆ˜ ì „ëµ.** ê¸°ì¡´ `lot_stacking.py`(ë£¨íŠ¸)ì—ì„œ ì´ë™.

`pre_tick()` â†’ `tick()` íë¦„:
1. ëŒ€ê¸° ë§¤ìˆ˜ ì£¼ë¬¸ í™•ì¸/ì²˜ë¦¬
2. ê¸°ì¤€ê°€(base_price) EMA ë¦¬ì„¼í„°
3. ê°€ê²© í•˜ë½ ì‹œ ë§¤ìˆ˜ ì£¼ë¬¸ ìƒì„±

> âŒ ì´ì „ ê²½ë¡œ: `app/strategies/lot_stacking.py` (ë£¨íŠ¸ ë ˆë²¨ â†’ `buys/`ë¡œ ì´ë™)

#### ğŸ†• `app/strategies/buys/trend.py` - TrendBuy
**ì¶”ì„¸ ë§¤ìˆ˜ ì „ëµ.** ê¸°ì¡´ `trend_buy.py`(ë£¨íŠ¸)ì—ì„œ ì´ë™ ë° ì½¤ë³´ ê¸°ë°˜ìœ¼ë¡œ ì¬ì„¤ê³„.

> âŒ ì´ì „ ê²½ë¡œ: `app/strategies/trend_buy.py` (ë£¨íŠ¸ ë ˆë²¨ â†’ `buys/`ë¡œ ì´ë™)

### ğŸ†• `app/strategies/sells/` - Sell Logic êµ¬í˜„ì²´

#### ğŸ†• `app/strategies/sells/fixed_tp.py` - FixedTpSell
**ê³ ì • ìµì ˆ ë§¤ë„ ì „ëµ.** ë¡œíŠ¸ì˜ ë§¤ìˆ˜ê°€ ëŒ€ë¹„ ì¼ì •% ìƒìŠ¹ ì‹œ ìµì ˆ ì£¼ë¬¸ ìƒì„±.

### ğŸ†• `app/strategies/sizing.py` - ì£¼ë¬¸ ì‚¬ì´ì§• ìœ í‹¸ë¦¬í‹°
ì£¼ë¬¸ ìˆ˜ëŸ‰/ê¸ˆì•¡ ê³„ì‚° ê³µí†µ ìœ í‹¸ë¦¬í‹°. Buy Logicì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©.

### ğŸ†• `app/strategies/utils.py` - ì „ëµ ê³µí†µ í—¬í¼
ì „ëµ ë¡œì§ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë³´ì¡° í•¨ìˆ˜ ëª¨ìŒ.

### `app/strategies/__init__.py` - ì „ëµ íŒ¨í‚¤ì§€ ì´ˆê¸°í™”
ëª¨ë“  ì „ëµ ê´€ë ¨ í´ë˜ìŠ¤ë¥¼ ì¬ìˆ˜ì¶œí•˜ê³ , buys/sells ëª¨ë“ˆì„ importí•˜ì—¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ìë™ ë“±ë¡.

---

## 8. âœï¸ app/services/ - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„œë¹„ìŠ¤

### âœï¸ `app/services/trading_engine.py` - ë©€í‹° ê³„ì • íŠ¸ë ˆì´ë”© ì—”ì§„
**ëª¨ë“  ê³„ì •ì˜ ìë™ë§¤ë§¤ë¥¼ ì´ê´„í•˜ëŠ” ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°.**

**âœï¸ ë™ì‘ ë°©ì‹:**
1. `start()`: ëª¨ë“  í™œì„± ê³„ì •ì„ DBì—ì„œ ë¡œë“œ â†’ ê° ê³„ì •ë§ˆë‹¤ `AccountTrader`ë¥¼ ìƒì„±í•˜ê³  asyncio Taskë¡œ ì‹¤í–‰
2. **ìŠ¤íƒœê±°ë“œ ìŠ¤ì¼€ì¤„ë§**: ê³„ì • ê°„ ì‹œì‘ ì‹œê°„ ë¶„ì‚°
3. **âœï¸ `KlineWsManager` ê´€ë¦¬**: ê³„ì • ì‹¬ë³¼ì— ë”°ë¼ WebSocket êµ¬ë…/í•´ì œ
4. `stop_account(id)`, `start_account(id)`: ê°œë³„ ê³„ì • ì‹œì‘/ì¤‘ì§€
5. `reload_account(id)`: ì¤‘ì§€ í›„ ì¬ì‹œì‘ (ì„¤ì • ë³€ê²½ ì ìš© ì‹œ)
6. **âœï¸** `resume_buying(account_id)`: Buy Pause ìƒíƒœì—ì„œ ìˆ˜ë™ ì¬ê°œ
7. `get_account_health()`: ëª¨ë“  ê³„ì •ì˜ ê±´ê°• ìƒíƒœ ì¡°íšŒ

**ê³µìœ  ìì›:**
- `PriceCollector`: ë™ì¼ ì‹¬ë³¼ ê°€ê²© ì¡°íšŒë¥¼ ì¤‘ë³µí•˜ì§€ ì•ŠìŒ
- `GlobalRateLimiter`: ëª¨ë“  ê³„ì •ì´ í•˜ë‚˜ì˜ ì†ë„ ì œí•œê¸°ë¥¼ ê³µìœ 
- **ğŸ†•** `KlineWsManager`: WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ ìº”ë“¤ ìˆ˜ì‹ 

### âœï¸ `app/services/account_trader.py` - ë‹¨ì¼ ê³„ì • ë§¤ë§¤ ë£¨í”„
**í•˜ë‚˜ì˜ ê³„ì •ì— ëŒ€í•œ ìë™ë§¤ë§¤ ë£¨í”„.** TradingEngineì´ ê° ê³„ì •ë§ˆë‹¤ í•˜ë‚˜ì”© ìƒì„±.

**âœï¸ `run_forever()` ë©”ì¸ ë£¨í”„:**
```
while ì‹¤í–‰ì¤‘:
    try:
        step()ì„ í˜¸ì¶œí•˜ì—¬ ë§¤ë§¤ ì‚¬ì´í´ 1íšŒ ì‹¤í–‰
    except ì˜¤ë¥˜:
        ì—°ì† ì‹¤íŒ¨ ì¹´ìš´í„° ì¦ê°€ â†’ 5íšŒ ì´ìƒì´ë©´ ì„œí‚· ë¸Œë ˆì´ì»¤ ë°œë™
        ì•„ë‹ˆë©´ â†’ ì§€ìˆ˜ ë°±ì˜¤í”„ (1s, 2s, 4s, 8s, max 60s)
    ì„±ê³µ ì‹œ:
        BuyPauseManager.compute_interval()ë¡œ ë£¨í”„ ê°„ê²© ë™ì  ê³„ì‚°
        asyncio.Event ê¸°ë°˜ ì¸í„°ëŸ½íŠ¸ ê°€ëŠ¥í•œ sleep (ì¬ê°œ ì‹ í˜¸ ì¦‰ì‹œ ë°˜ì‘)
```

**âœï¸ `step()` ë§¤ë§¤ ì‚¬ì´í´:**
1. DBì—ì„œ ê³„ì • ì •ë³´ ë¡œë“œ
2. ë ˆì´íŠ¸ ë¦¬ë¯¸í„°ì—ì„œ API í˜¸ì¶œ ìš©ëŸ‰ í™•ë³´
3. ê±°ë˜ì†Œì™€ ì£¼ë¬¸/ì²´ê²° ë°ì´í„° ë™ê¸°í™”
4. í˜„ì¬ ê°€ê²© ì¡°íšŒ (PriceCollector ê²½ìœ )
5. **âœï¸ í™œì„±í™”ëœ ì½¤ë³´ë“¤ì˜ Buy/Sell tick() ì‹¤í–‰** (strategy_configs ëŒ€ì‹  trading_combos ì‚¬ìš©)
6. **âœï¸ BuyPauseManager.should_attempt_buy()** í™•ì¸ í›„ ë§¤ìˆ˜ ì§„í–‰ ì—¬ë¶€ ê²°ì •
7. ì„±ê³µ ê¸°ë¡

### `app/services/rate_limiter.py` - API ì†ë„ ì œí•œê¸°
ë°”ì´ë‚¸ìŠ¤ APIì˜ ì†ë„ ì œí•œ(1200 weight/ë¶„)ì— ê±¸ë¦¬ì§€ ì•Šë„ë¡ ë³´í˜¸.

**`GlobalRateLimiter`:** `aiolimiter`ì˜ `AsyncLimiter` ë˜í•‘. ê¸°ë³¸ 1000 weight/ë¶„.

### âœï¸ `app/services/price_collector.py` - ê°€ê²© ìˆ˜ì§‘ê¸°
**âœï¸ ì™„ì „ ì¬ì„¤ê³„.** WS â†’ ìºì‹œ â†’ REST í´ë°± ì²´ì¸ìœ¼ë¡œ ë™ì‘.

**âœï¸ ë™ì‘:**
1. **WebSocket ìš°ì„ **: `KlineWsManager`ì—ì„œ ì‹¤ì‹œê°„ ê°€ê²© ìˆ˜ì‹ 
2. **ìºì‹œ í´ë°±**: WS ë°ì´í„° ì—†ìœ¼ë©´ ë©”ëª¨ë¦¬ ìºì‹œ ë°˜í™˜
3. **REST í´ë°±**: ìºì‹œë„ ì—†ìœ¼ë©´ ê±°ë˜ì†Œ REST API í˜¸ì¶œ
4. **âœï¸** `set_kline_ws(ws_manager)`: WS ë§¤ë‹ˆì € ì—°ê²° (TradingEngineì—ì„œ ì£¼ì…)

> âŒ ì œê±°ë¨: `maybe_store_snapshot()`, `maybe_store_candle()` (CandleStoreë¡œ ë¶„ë¦¬)

### `app/services/account_service.py` - ê³„ì • ì„œë¹„ìŠ¤
ê³„ì • CRUD + API í‚¤ ì•”í˜¸í™” ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µ.

**ì£¼ìš” ê¸°ëŠ¥:**
- `create_account(...)`: ê³„ì • ìƒì„± ì‹œ API í‚¤ë¥¼ MultiFernetìœ¼ë¡œ **ì•”í˜¸í™” í›„ ì €ì¥**
- `decrypt_api_key(account)` / `decrypt_api_secret(account)`: ë³µí˜¸í™”
- `update_api_keys(account_id, ...)`: API í‚¤ ë³€ê²½ ì‹œ ì¬ì•”í˜¸í™”
- `reset_circuit_breaker(account_id)`: ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹

### `app/services/account_state_manager.py` - ê³µìœ  ìƒíƒœ ë§¤ë‹ˆì €
LOTê³¼ TREND ì „ëµì´ **ê³µìœ í•˜ëŠ” ë¦¬ì €ë¸Œ í’€**ì„ ê´€ë¦¬.

ë‚´ë¶€ì ìœ¼ë¡œ `StrategyStateStore(account_id, scope="shared", session)`ì„ ì‚¬ìš©.

**ì£¼ìš” ë©”ì„œë“œ:** `get_reserve_qty()`, `set_reserve_qty(v)`, `get_reserve_cost_usdt()`, `add_to_reserve(qty, cost)`

### âœï¸ `app/services/auth_service.py` - ì¸ì¦ ì„œë¹„ìŠ¤
**âœï¸ ë¡œì»¬ DB ê¸°ë°˜ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì¸ì¦.** (ì´ì „: Supabase Google OAuth)

**âœï¸ ì£¼ìš” ë©”ì„œë“œ:**
- `create_user(email, password, role)`: ì‚¬ìš©ì ìƒì„±, bcrypt í•´ì‹œ
- `authenticate(email, password)`: ë¡œê·¸ì¸ ê²€ì¦ (bcrypt.verify)
- `get_user_by_id(user_id)`: ì‚¬ìš©ì ì¡°íšŒ
- `get_user_role(user_id)`: ì—­í•  ì¡°íšŒ
- `ensure_admin(email, password)`: ì´ˆê¸° ê´€ë¦¬ì ìë™ ìƒì„± (bootstrapìš©)

> âŒ ì œê±°ë¨: Google OAuth URL ìƒì„±, OAuth ì½œë°± ì½”ë“œ êµí™˜, Supabase í† í° ê°±ì‹ 

### âœï¸ `app/services/session_manager.py` - ì„¸ì…˜ ë§¤ë‹ˆì €
**âœï¸ ë¡œì»¬ ì„¸ì…˜ í† í° ê´€ë¦¬.** `itsdangerous`ë¡œ uid/email/roleì„ ì„œëª…ëœ ì¿ í‚¤ì— ì¸ì½”ë”©. (ì´ì „: Supabase access/refresh token ì €ì¥)

**âœï¸ ë™ì‘:**
1. `create_session_cookie(user_id, email, role)`: ì‚¬ìš©ì ì •ë³´ë¥¼ ì„œëª…ëœ ì¿ í‚¤ ê°’ìœ¼ë¡œ ì¸ì½”ë”©
2. `read_session_cookie(cookie_value)`: ì¿ í‚¤ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ (ì„œëª… ê²€ì¦ + ë§Œë£Œ í™•ì¸)

### ğŸ†• `app/services/buy_pause_manager.py` - Buy Pause ë§¤ë‹ˆì €
ì”ê³  ë¶€ì¡± ì‹œ ë§¤ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ì¼ì‹œì •ì§€í•˜ëŠ” **ìƒíƒœ ê¸°ê³„**.

**ìƒíƒœ ì „ì´:**
```
ACTIVE â†’ THROTTLED (ì—°ì† ì”ê³  ë¶€ì¡± ê°ì§€) â†’ PAUSED (ì„ê³„ê°’ ì´ˆê³¼)
PAUSED â†’ ACTIVE (ìˆ˜ë™ resume() ë˜ëŠ” ì”ê³  íšŒë³µ)
```

**ì£¼ìš” ë©”ì„œë“œ:**
- `should_attempt_buy(account_id)`: í˜„ì¬ ìƒíƒœì—ì„œ ë§¤ìˆ˜ ì‹œë„ ê°€ëŠ¥ ì—¬ë¶€
- `update_state(account_id, had_sufficient_balance)`: ë§¤ë§¤ ì‚¬ì´í´ í›„ ìƒíƒœ ê°±ì‹ 
- `resume(account_id)`: ìˆ˜ë™ ì¬ê°œ (`/buy-pause/resume` APIì—ì„œ í˜¸ì¶œ)
- `compute_interval(account_id)`: THROTTLED ìƒíƒœì¼ ë•Œ ë£¨í”„ ê°„ê²© ì—°ì¥ ê°’ ë°˜í™˜

### ğŸ†• `app/services/kline_ws_manager.py` - WebSocket ìº”ë“¤ ë§¤ë‹ˆì €
ë°”ì´ë‚¸ìŠ¤ WebSocketì„ í†µí•´ ì‹¤ì‹œê°„ 1ë¶„ë´‰ ìº”ë“¤ì„ ìˆ˜ì‹ í•˜ê³  DBì— ì €ì¥.

**ì£¼ìš” ê¸°ëŠ¥:**
- `subscribe(symbol)` / `unsubscribe(symbol)`: ë ˆí¼ì¹´ìš´íŠ¸ ê¸°ë°˜ êµ¬ë… ê´€ë¦¬
- `multiplex_socket`: ì—¬ëŸ¬ ì‹¬ë³¼ì„ í•˜ë‚˜ì˜ WebSocket ì—°ê²°ë¡œ ë©€í‹°í”Œë ‰ì‹±
- **ìŠˆí¼ë°”ì´ì € ë£¨í”„**: ì—°ê²° ëŠê¹€ ì‹œ ìë™ ì¬ì—°ê²°
- **REST ë°±í•„**: êµ¬ë… ì‹œì‘ ì‹œ ìµœê·¼ ìº”ë“¤ REST APIë¡œ ë³´ì¶©
- ìˆ˜ì‹ ëœ 1m ìº”ë“¤ì„ `CandleStore`ë¥¼ í†µí•´ DBì— ì €ì¥

### ğŸ†• `app/services/candle_store.py` - ìº”ë“¤ ì €ì¥ì†Œ
ìº”ë“¤ ë°ì´í„° CRUD ì„œë¹„ìŠ¤.

**ì£¼ìš” ë©”ì„œë“œ:**
- `store_closed_candle_1m(symbol, candle_data)`: 1ë¶„ë´‰ ë‹¨ê±´ ì €ì¥
- `store_candles_batch_1m(symbol, candles)`: 1ë¶„ë´‰ ë°°ì¹˜ ì €ì¥ (REST ë°±í•„ìš©)
- `get_candles(symbol, from_ms, to_ms, interval)`: ì¡°íšŒ (`price_repo` ìœ„ì„)
- `aggregate_candles(symbol, from_interval, to_interval)`: í•˜ìœ„ íƒ€ì„í”„ë ˆì„ â†’ ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì§‘ê³„
- `delete_old_candles(symbol, interval, before_ms)`: ì˜¤ë˜ëœ ìº”ë“¤ ì •ë¦¬

### ğŸ†• `app/services/candle_aggregator.py` - ìº”ë“¤ ì§‘ê³„ê¸°
ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ìº”ë“¤ì„ ì§‘ê³„í•˜ëŠ” ì„œë¹„ìŠ¤. ì•± ì‹œì‘ ì‹œ `TradingEngine`ì´ ì‹œì‘.

**ì§‘ê³„ ìŠ¤ì¼€ì¤„ (6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰):**
- 1m â†’ 5m: ìµœê·¼ 7ì¼
- 5m â†’ 1h: ìµœê·¼ 30ì¼
- 1h â†’ 1d: ìµœê·¼ 90ì¼

### ğŸ†• `app/services/combo_reapply.py` - ì½¤ë³´ ì¬ì ìš©
ì½¤ë³´ íŒŒë¼ë¯¸í„° ë³€ê²½ ì‹œ ê¸°ì¡´ ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ê³  ìƒˆ íŒŒë¼ë¯¸í„°ë¡œ ì¬ì„¤ì •.
`PUT /api/accounts/{id}/combos/{combo_id}/reapply` APIì—ì„œ í˜¸ì¶œ.

---

## 9. app/middleware/ - HTTP ë¯¸ë“¤ì›¨ì–´

### `app/middleware/auth_middleware.py` - ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
ë…ë¦½ íŒŒì¼ë¡œ ì •ì˜ëœ `AuthMiddleware` í´ë˜ìŠ¤. (í˜„ì¬ëŠ” `main.py`ì˜ `LazyAuthMiddleware`ê°€ ì‹¤ì œ ì‚¬ìš©ë¨)

**âœï¸ `LazyAuthMiddleware`** (main.pyì— ì •ì˜):
- ìš”ì²­ ì‹œì ì— `app.state`ì—ì„œ auth_serviceë¥¼ ê°€ì ¸ì™€ ë¡œì»¬ DB ì„¸ì…˜ ê²€ì¦

### `app/middleware/csrf_middleware.py` - CSRF ì„¤ì •
`starlette-csrf` ë¯¸ë“¤ì›¨ì–´ ì„¤ì •. SSR í¼ POST ìš”ì²­ì— CSRF í† í° ìš”êµ¬.

**ë©´ì œ ê²½ë¡œ:** `/api/auth/callback`, `/health`

---

## 10. âœï¸ app/api/ - REST API ì—”ë“œí¬ì¸íŠ¸

### âœï¸ `app/api/__init__.py` - API íŒ¨í‚¤ì§€
**âœï¸ 8ê°œ ë¼ìš°í„°**ë¥¼ ëª¨ì•„ì„œ ì¬ìˆ˜ì¶œ (ê¸°ì¡´ 7ê°œì—ì„œ `combos_router`, `backtest_router` ì¶”ê°€).

### `app/api/health.py` - í—¬ìŠ¤ ì²´í¬ (`GET /health`)
ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥. ì‹œìŠ¤í…œ ê±´ê°• ìƒíƒœ ë°˜í™˜.

### âœï¸ `app/api/auth.py` - ì¸ì¦ API (`/api/auth/*`)

| ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|------------|------|
| **âœï¸** `POST /api/auth/login` | ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ â†’ ì„¸ì…˜ ì¿ í‚¤ ì„¤ì • |
| `POST /api/auth/logout` | ì„¸ì…˜ ì¿ í‚¤ ì‚­ì œ â†’ /loginìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ |
| `GET /api/auth/me` | í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ |

> âŒ ì œê±°ë¨: `GET /api/auth/google`, `GET /api/auth/callback` (Google OAuth ì œê±°)

### âœï¸ `app/api/accounts.py` - ê³„ì • ê´€ë¦¬ API (`/api/accounts/*`)

| ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|------------|------|
| `GET /api/accounts` | ë‚´ ê³„ì • ëª©ë¡ |
| `POST /api/accounts` | ê³„ì • ìƒì„± |
| `GET /api/accounts/{id}` | ê³„ì • ìƒì„¸ |
| `PUT /api/accounts/{id}` | ê³„ì • ìˆ˜ì • |
| `DELETE /api/accounts/{id}` | ê³„ì • ì‚­ì œ |
| `POST /api/accounts/{id}/start` | ë§¤ë§¤ ì‹œì‘ |
| `POST /api/accounts/{id}/stop` | ë§¤ë§¤ ì¤‘ì§€ |
| `POST /api/accounts/{id}/reset-circuit-breaker` | ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹ (ê´€ë¦¬ì) |
| **ğŸ†•** `POST /api/accounts/{id}/buy-pause/resume` | Buy Pause ìˆ˜ë™ ì¬ê°œ |

### âŒ `app/api/strategies.py` - (ì œê±°ë¨)
~~ì „ëµ API~~ â€” `combos.py`ë¡œ ëŒ€ì²´ë¨.

### ğŸ†• `app/api/combos.py` - ì½¤ë³´ API

| ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|------------|------|
| `GET /api/buy-logics` | ì‚¬ìš© ê°€ëŠ¥í•œ Buy Logic ëª©ë¡ + íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆ |
| `GET /api/sell-logics` | ì‚¬ìš© ê°€ëŠ¥í•œ Sell Logic ëª©ë¡ + íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆ |
| `GET /api/accounts/{id}/combos` | ê³„ì •ì˜ ì½¤ë³´ ëª©ë¡ |
| `POST /api/accounts/{id}/combos` | ì½¤ë³´ ìƒì„± |
| `PUT /api/accounts/{id}/combos/{combo_id}` | ì½¤ë³´ ìˆ˜ì • |
| `DELETE /api/accounts/{id}/combos/{combo_id}` | ì½¤ë³´ ì‚­ì œ |
| `POST /api/accounts/{id}/combos/{combo_id}/reapply` | íŒŒë¼ë¯¸í„° ë³€ê²½ í›„ ëŒ€ê¸° ì£¼ë¬¸ ì¬ì ìš© |

### âœï¸ `app/api/dashboard.py` - ëŒ€ì‹œë³´ë“œ ë°ì´í„° API (`/api/dashboard/*`)

| ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|------------|------|
| `GET /api/dashboard/{id}` | ê³„ì •ë³„ ëŒ€ì‹œë³´ë“œ ì¢…í•© (í¬ì§€ì…˜, ë¡œíŠ¸ ìˆ˜, ìˆ˜ìµ, ë¦¬ì €ë¸Œ, **âœï¸ buy_pause ìƒíƒœ**, ê±´ê°• ìƒíƒœ) |
| `GET /api/dashboard/{id}/lots` | ë¡œíŠ¸ ëª©ë¡ |
| `GET /api/dashboard/{id}/trades` | ì£¼ë¬¸ ë‚´ì—­ |
| **âœï¸** `GET /api/dashboard/{id}/price_candles` | ìº”ë“¤ ì°¨íŠ¸ ë°ì´í„° (interval íŒŒë¼ë¯¸í„°: 1m/5m/1h/1d) |
| `GET /api/dashboard/{id}/tune` | íŠœë‹ ê°’ ì¡°íšŒ |
| `POST /api/dashboard/{id}/tune` | íŠœë‹ ê°’ ì €ì¥ |

### `app/api/admin.py` - ê´€ë¦¬ì API (`/api/admin/*`)

| ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|------------|------|
| `GET /api/admin/accounts` | ì „ì²´ ê³„ì • ëª©ë¡ + ê±´ê°• ìƒíƒœ |
| `GET /api/admin/users` | ì „ì²´ ì‚¬ìš©ì ëª©ë¡ |
| `GET /api/admin/overview` | ì‹œìŠ¤í…œ ì „ì²´ í˜„í™© |
| `POST /api/admin/users/{id}/role` | ì‚¬ìš©ì ì—­í•  ë³€ê²½ |

### âœï¸ `app/api/backtest.py` - ë°±í…ŒìŠ¤íŠ¸ API (`/api/backtest/*`)
**âœï¸ ì½¤ë³´ ê¸°ë°˜ìœ¼ë¡œ ì¬ì„¤ê³„. ë¹„ë™ê¸° ì‹¤í–‰ + ì˜ì†ì  ê²°ê³¼ ì €ì¥.**

| ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|------------|------|
| **âœï¸** `POST /api/backtest/run` | ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìš”ì²­ â†’ `backtest_run` í–‰ ìƒì„± í›„ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰. run_id ì¦‰ì‹œ ë°˜í™˜ |
| **ğŸ†•** `GET /api/backtest/list` | ë‚´ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëª©ë¡ |
| **ğŸ†•** `GET /api/backtest/{id}/status` | ì‹¤í–‰ ìƒíƒœ ì¡°íšŒ (PENDING/RUNNING/DONE/FAILED) |
| **ğŸ†•** `GET /api/backtest/{id}/report` | ì™„ë£Œëœ ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¡°íšŒ (ìš”ì•½ + ê±°ë˜ ë‚´ì—­ + equity curve) |
| **ğŸ†•** `DELETE /api/backtest/{id}` | ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì‚­ì œ |

---

## 11. âœï¸ app/schemas/ - API ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆ

Pydantic v2 ëª¨ë¸. APIì˜ ìš”ì²­ ë°”ë””ì™€ ì‘ë‹µ í˜•ì‹ì„ ì •ì˜í•˜ê³  ìë™ ê²€ì¦.

### `app/schemas/auth.py`
- `UserResponse`: ì‚¬ìš©ì ì •ë³´ (id, email, role)
- **âœï¸** `LoginRequest`: ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ìš”ì²­

### `app/schemas/account.py`
- `AccountCreate`: ê³„ì • ìƒì„± ìš”ì²­
- `AccountUpdate`: ê³„ì • ìˆ˜ì • ìš”ì²­
- `AccountResponse`: ê³„ì • ìƒì„¸ ì‘ë‹µ (API í‚¤ ì œì™¸)
- `AccountListResponse`: ê³„ì • ëª©ë¡ ì‘ë‹µ

### `app/schemas/trade.py`
- `LotResponse`: ë¡œíŠ¸ ì •ë³´ (ë§¤ìˆ˜ê°€, ìˆ˜ëŸ‰, ìƒíƒœ, ì†ìµ)
- `OrderResponse`: ì£¼ë¬¸ ì •ë³´

### âœï¸ `app/schemas/dashboard.py`
- `DashboardSummary`: ëŒ€ì‹œë³´ë“œ ì¢…í•© ë°ì´í„°. **âœï¸ buy_pause_state, buy_pause_reason í•„ë“œ ì¶”ê°€**
- `AssetStatus`: ìì‚° í˜„í™©
- `TuneValues`: íŠœë‹ ê°’ ì¡°íšŒ ì‘ë‹µ
- `TuneUpdate`: íŠœë‹ ê°’ ìˆ˜ì • ìš”ì²­

### `app/schemas/settings.py`
- `StrategyStateResponse`: ì „ëµ ìƒíƒœ í‚¤-ê°’
- `AccountSettingsResponse`: ê³„ì • ì„¤ì • ì¢…í•©

### ğŸ†• `app/schemas/backtest.py`
- `BacktestRunRequest`: ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìš”ì²­ (symbol, combos, initial_usdt, start/end_ts_ms)
- `BacktestRunResponse`: ì‹¤í–‰ ìš”ì²­ ì‘ë‹µ (run_id)
- `BacktestStatusResponse`: ìƒíƒœ ì¡°íšŒ ì‘ë‹µ
- `BacktestReportResponse`: ì™„ë£Œ ê²°ê³¼ ì‘ë‹µ (result_summary, trade_log, equity_curve)

---

## 12. âœï¸ app/dashboard/ - ëŒ€ì‹œë³´ë“œ UI (SSR)

ì„œë²„ì‚¬ì´ë“œ ë Œë”ë§(SSR) ë°©ì‹ì˜ ì›¹ ëŒ€ì‹œë³´ë“œ. FastAPI + Jinja2 í…œí”Œë¦¿.

### `app/dashboard/routes.py` - í˜ì´ì§€ ë¼ìš°íŠ¸

| ê²½ë¡œ | ì„¤ëª… |
|------|------|
| `/login` | **âœï¸** ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ í˜ì´ì§€ (ê³µê°œ) |
| `/accounts` | ë‚´ ê³„ì • ëª©ë¡ (ì¸ì¦ í•„ìš”) |
| `/accounts/{account_id}` | ê³„ì •ë³„ ëŒ€ì‹œë³´ë“œ (ì¸ì¦ í•„ìš”) |
| `/admin` | ê´€ë¦¬ì ì „ì²´ ë·° (adminë§Œ) |

### `app/dashboard/templates/base.html` - ë² ì´ìŠ¤ ë ˆì´ì•„ì›ƒ
ëª¨ë“  í˜ì´ì§€ê°€ ìƒì†í•˜ëŠ” HTML í…œí”Œë¦¿.

### âœï¸ `app/dashboard/templates/login.html` - ë¡œê·¸ì¸ í˜ì´ì§€
**âœï¸** ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼. `POST /api/auth/login`ìœ¼ë¡œ ì œì¶œ.

### `app/dashboard/templates/accounts.html` - ê³„ì • ëª©ë¡
ê³„ì • ì¹´ë“œ ê·¸ë¦¬ë“œ. JSë¡œ `/api/accounts`ì—ì„œ ë°ì´í„° ë¡œë”©.

### âœï¸ `app/dashboard/templates/account_detail.html` - ê³„ì • ëŒ€ì‹œë³´ë“œ
**ê°€ì¥ ë³µì¡í•œ í˜ì´ì§€.** 5ê°œ ì„¹ì…˜:

1. **ê°€ê²© ì°¨íŠ¸**: LightweightCharts CDNìœ¼ë¡œ ìº”ë“¤ ì°¨íŠ¸ í‘œì‹œ (ë‹¤ì¤‘ íƒ€ì„í”„ë ˆì„)
2. **ìì‚° í˜„í™©**: BTC ì”ê³ , USDT ì”ê³ , ë¦¬ì €ë¸Œ í’€ ì •ë³´, **ğŸ†• Buy Pause ìƒíƒœ ë°°ì§€**
3. **ë¡œíŠ¸ í…Œì´ë¸”**: ì½¤ë³´ë³„ ë³´ìœ  ë¡œíŠ¸ (ë§¤ìˆ˜ê°€, ìˆ˜ëŸ‰, ì†ìµ)
4. **íŠœë‹ ì»¨íŠ¸ë¡¤**: ì „ëµ íŒŒë¼ë¯¸í„° ì‹¤ì‹œê°„ ì¡°ì • í¼ (POST with CSRF)
5. **ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœ**: ë°œë™ ì—¬ë¶€ + ë¦¬ì…‹ ë²„íŠ¼

### `app/dashboard/templates/admin.html` - ê´€ë¦¬ì ë·°
ì‹œìŠ¤í…œ ê±´ê°• ìš”ì•½, ì „ì²´ ê³„ì • í…Œì´ë¸”, ì „ì²´ ì‚¬ìš©ì í…Œì´ë¸”.

### ğŸ†• `app/dashboard/templates/backtest_report.html` - ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ í˜ì´ì§€
ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ ì‹œê°í™”í•˜ëŠ” í˜ì´ì§€. equity curve ì°¨íŠ¸, ê±°ë˜ ë‚´ì—­ í…Œì´ë¸”.

### âœï¸ `app/dashboard/static/css/style.css` - ìŠ¤íƒ€ì¼ì‹œíŠ¸
ë‹¤í¬ í…Œë§ˆ íŠ¸ë ˆì´ë”© ëŒ€ì‹œë³´ë“œ ë””ìì¸.
- CSS ë³€ìˆ˜: `--bg: #0f172a`, `--card-bg: #1e293b`, `--primary: #2563eb`
- ë°˜ì‘í˜• ê·¸ë¦¬ë“œ, ì¹´ë“œ, í…Œì´ë¸”, í¼, ë²„íŠ¼, ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼
- **ğŸ†• Buy Pause ë°°ì§€ ìŠ¤íƒ€ì¼**: THROTTLED=ì£¼í™©ìƒ‰, PAUSED=ë…¸ë€ìƒ‰

### âœï¸ `app/dashboard/static/js/main.js` - í´ë¼ì´ì–¸íŠ¸ JavaScript
**âœï¸ ì½¤ë³´ ê¸°ë°˜ UI, Buy Pause ìƒíƒœ í‘œì‹œë¡œ ì—…ë°ì´íŠ¸.**

**í•µì‹¬ í•¨ìˆ˜:**
- `apiFetch(url, options)`: fetch ë˜í¼ (credentials í¬í•¨, 401 ì‹œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸)
- `getCsrfToken()`: meta íƒœê·¸ ë˜ëŠ” ì¿ í‚¤ì—ì„œ CSRF í† í° ì¶”ì¶œ
- `loadAccounts()`: ê³„ì • ëª©ë¡ ë¡œë”© ë° ì¹´ë“œ ë Œë”ë§
- **âœï¸** `loadPriceChart(accountId, interval)`: ë‹¤ì¤‘ íƒ€ì„í”„ë ˆì„ ìº”ë“¤ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
- `loadLots(accountId)`: ë¡œíŠ¸ í…Œì´ë¸” ë Œë”ë§ + ì½¤ë³´ë³„ í•„í„° íƒ­
- `loadTuneValues(accountId)`: íŠœë‹ í¼ì— í˜„ì¬ ê°’ ì±„ìš°ê¸°
- `saveTuneValues(accountId)`: íŠœë‹ ê°’ POST (CSRF í† í° í¬í•¨)
- `resetCircuitBreaker(accountId)`: ì„œí‚· ë¸Œë ˆì´ì»¤ ë¦¬ì…‹ API í˜¸ì¶œ
- **ğŸ†•** `renderBuyPauseBadge(state)`: THROTTLED(ì£¼í™©), PAUSED(ë…¸ë€) ë°°ì§€ ë Œë”ë§
- **ğŸ†•** `resumeBuying(accountId)`: Buy Pause ìˆ˜ë™ ì¬ê°œ API í˜¸ì¶œ
- `loadAdminOverview()`: ê´€ë¦¬ì í˜ì´ì§€ ë°ì´í„° ë¡œë”©

---

## 13. app/utils/ - ìœ í‹¸ë¦¬í‹°

### `app/utils/encryption.py` - ì•”í˜¸í™” ë§¤ë‹ˆì €
**MultiFernet ë‹¤ì¤‘ í‚¤ ì•”í˜¸í™”.**

- ì•”í˜¸í™”: **ì²« ë²ˆì§¸ í‚¤(newest)**ë¡œ ìˆ˜í–‰
- ë³µí˜¸í™”: **ëª¨ë“  í‚¤ë¥¼ ìˆœì„œëŒ€ë¡œ** ì‹œë„ (í‚¤ ë¡œí…Œì´ì…˜ ì•ˆì „)
- í‚¤ ë¡œí…Œì´ì…˜: ìƒˆ í‚¤ë¥¼ `ENCRYPTION_KEYS` ë§¨ ì•ì— ì¶”ê°€

### `app/utils/logging.py` - êµ¬ì¡°í™” ë¡œê¹…
**JSON í˜•ì‹ ë¡œê¹…** + `account_id` ì»¨í…ìŠ¤íŠ¸ ìë™ í¬í•¨.

```json
{
  "ts": "2026-02-26 10:00:00",
  "level": "INFO",
  "account_id": "uuid-of-account",
  "msg": "ë§¤ìˆ˜ ì£¼ë¬¸ ìƒì„±: BTCUSDT @ 50000",
  "module": "lot_stacking"
}
```

`current_account_id`: `contextvars.ContextVar`ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° ë§¤ë§¤ ë£¨í”„ì—ì„œ ìë™ìœ¼ë¡œ í•´ë‹¹ ê³„ì • IDê°€ ëª¨ë“  ë¡œê·¸ì— í¬í•¨ë¨.

---

## 14. âœï¸ alembic/ - DB ë§ˆì´ê·¸ë ˆì´ì…˜

### `alembic/env.py` - Alembic í™˜ê²½ ì„¤ì •
SQLAlchemy ëª¨ë¸ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ Alembicì— ì—°ê²°. ë¹„ë™ê¸° ì—”ì§„ ì‚¬ìš©.

### `alembic/versions/001_initial_schema.py` - ì´ˆê¸° ìŠ¤í‚¤ë§ˆ
ê¸°ì¡´ í…Œì´ë¸” ìƒì„± ë§ˆì´ê·¸ë ˆì´ì…˜ (11ê°œ í…Œì´ë¸”, ì¸ë±ìŠ¤).

### ğŸ†• `alembic/versions/002_backtest_runs.py`
`backtest_runs` í…Œì´ë¸” ì¶”ê°€.

### ğŸ†• `alembic/versions/003_local_auth.py`
`user_profiles` í…Œì´ë¸”ì— `password_hash` ì»¬ëŸ¼ ì¶”ê°€. Supabase Auth ì˜ì¡´ì„± ì œê±°.

### ğŸ†• `alembic/versions/004_trading_combos.py`
`trading_combos` í…Œì´ë¸” ì¶”ê°€.

### ğŸ†• `alembic/versions/005_backtest_combos.py`
ë°±í…ŒìŠ¤íŠ¸ ì½¤ë³´ ê´€ë ¨ ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸.

### ğŸ†• `alembic/versions/006_reserve_pool_redesign.py`
ë¦¬ì €ë¸Œ í’€ êµ¬ì¡° ì¬ì„¤ê³„.

### ğŸ†• `alembic/versions/007_buy_pause.py`
`trading_accounts`ì— Buy Pause ì»¬ëŸ¼ 4ê°œ ì¶”ê°€.

### ğŸ†• `alembic/versions/008_candle_tables.py`
`price_candles_1m`, `price_candles_1h`, `price_candles_1d` í…Œì´ë¸” ì¶”ê°€. `price_candles_5m`ì— volume ì»¬ëŸ¼ ì¶”ê°€.

---

## 15. âœï¸ backtest/ - ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„

### âŒ `backtest/runner.py` - (ëŒ€ì²´ë¨)
~~ê³¼ê±° ê°€ê²© ë°ì´í„°ë¡œ ì „ëµì˜ ìˆ˜ìµë¥ ì„ ì‹œë®¬ë ˆì´ì…˜.~~

`isolated_runner.py`ë¡œ ëŒ€ì²´ë¨.

### ğŸ†• `backtest/isolated_runner.py` - ê²©ë¦¬ëœ ë°±í…ŒìŠ¤íŠ¸ ëŸ¬ë„ˆ
**íŠ¸ëœì­ì…˜ ë¡¤ë°± ë°©ì‹ì˜ ê²©ë¦¬ ì‹¤í–‰.** ì½¤ë³´ ê¸°ë°˜.

**ë™ì‘:**
1. `backtest_runs` í…Œì´ë¸”ì—ì„œ PENDING ì‘ì—… í”½ì—…
2. DB íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ì„ì‹œ account/state í–‰ ìƒì„±
3. 1m ìº”ë“¤ ìš°ì„  ë¡œë“œ, ì—†ìœ¼ë©´ 5m ìº”ë“¤ë¡œ í´ë°±
4. `BacktestClient` ìƒì„± (ê°€ìƒ ê±°ë˜ì†Œ)
5. ê° ìº”ë“¤ì— ëŒ€í•´: `client.set_price()` â†’ ì½¤ë³´ Buy/Sell tick() ì‹¤í–‰
6. ìµœì¢… ì”ê³  ê³„ì‚° â†’ `result_summary`, `trade_log`, `equity_curve` ì €ì¥
7. ì„ì‹œ í–‰ ë¡¤ë°± (DB ì˜¤ì—¼ ì—†ìŒ)
8. **ë™ì‹œ ì‹¤í–‰ ì œí•œ**: ìµœëŒ€ 3ê°œ ë™ì‹œ ë°±í…ŒìŠ¤íŠ¸

---

## 16. âœï¸ scripts/ - ìš´ì˜ ìŠ¤í¬ë¦½íŠ¸

### `scripts/migrate_from_old.py` - ê¸°ì¡´ ë´‡ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
`btc-staking-bot`ì˜ ë°ì´í„°ë¥¼ ìƒˆ ì‹œìŠ¤í…œìœ¼ë¡œ ì´ê´€.

### `scripts/rotate_encryption_key.py` - ì•”í˜¸í™” í‚¤ ë¡œí…Œì´ì…˜
ëª¨ë“  ê³„ì •ì˜ API í‚¤ë¥¼ ìƒˆ ì•”í˜¸í™” í‚¤ë¡œ ì¬ì•”í˜¸í™”.

### ğŸ†• `scripts/create_admin.py` - ê´€ë¦¬ì ê³„ì • ìƒì„±
ìµœì´ˆ ì„¤ì¹˜ ì‹œ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬ì ê³„ì •ì„ ìƒì„±í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸.
(`INITIAL_ADMIN_*` í™˜ê²½ë³€ìˆ˜ ìë™ bootstrapì˜ ëŒ€ì•ˆ)

```bash
python scripts/create_admin.py --email admin@example.com --password "secret"
```

### ğŸ†• `scripts/fetch_klines.py` - ê³¼ê±° ìº”ë“¤ ë°ì´í„° ìˆ˜ì§‘
ë°”ì´ë‚¸ìŠ¤ REST APIë¡œ ì—­ì‚¬ì  ìº”ë“¤ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ Parquet íŒŒì¼ë¡œ ì €ì¥.
ë°±í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ìš©.

```bash
python scripts/fetch_klines.py --symbol BTCUSDT --interval 1m --start 2024-01-01
```

### ğŸ†• `scripts/migrate_strategy_to_combo.py` - ì „ëµ â†’ ì½¤ë³´ ë§ˆì´ê·¸ë ˆì´ì…˜
ê¸°ì¡´ `strategy_configs` í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ `trading_combos`ë¡œ ë³€í™˜.
ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ ì‹œ 1íšŒ ì‹¤í–‰.

### ğŸ†• `scripts/preview_ui.py` - UI ë¯¸ë¦¬ë³´ê¸° ì„œë²„
ì „ëµ íŒŒë¼ë¯¸í„° íŠœë‹ ì¤‘ UIë¥¼ ë¹ ë¥´ê²Œ ë¯¸ë¦¬ë³´ê¸° ìœ„í•œ ê²½ëŸ‰ ì„œë²„.

---

## 17. docker/ - ì»¨í…Œì´ë„ˆ ë°°í¬

### `docker/Dockerfile`
2ë‹¨ê³„ ë¹Œë“œ:
1. **builder ë‹¨ê³„**: Python 3.12-slimì—ì„œ requirements.txt ì„¤ì¹˜
2. **runtime ë‹¨ê³„**: ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ë§Œ ë³µì‚¬, ë¹„root ì‚¬ìš©ìë¡œ ì‹¤í–‰

### `docker/docker-compose.yml`
ë‘ ì„œë¹„ìŠ¤:
- **app**: ë©”ì¸ ì•± (í¬íŠ¸ 8000, .env ë¡œë”©)
- **db**: PostgreSQL 16 Alpine (ë³¼ë¥¨ ë§ˆìš´íŠ¸ë¡œ ë°ì´í„° ì˜ì†í™”)

---

## 18. systemd/ - ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤

### `systemd/crypto-multi-trader.service`
Linux systemd ì„œë¹„ìŠ¤ íŒŒì¼. `Restart=always`ë¡œ í¬ë˜ì‹œ ì‹œ ìë™ ì¬ì‹œì‘.
ë³´ì•ˆ ê°•í™”: `NoNewPrivileges`, `PrivateTmp`, `ProtectSystem=strict`.

---

## 19. âœï¸ tests/ - í…ŒìŠ¤íŠ¸

í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ êµ¬ì¡°. ê° ëª¨ë“ˆë³„ í…ŒìŠ¤íŠ¸ íŒ¨í‚¤ì§€:
- `tests/test_api/`: API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
- `tests/test_exchange/`: ê±°ë˜ì†Œ í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸
- `tests/test_services/`: ì„œë¹„ìŠ¤ ê³„ì¸µ í…ŒìŠ¤íŠ¸
- `tests/test_strategies/`: ì „ëµ ë¡œì§ í…ŒìŠ¤íŠ¸
- **ğŸ†•** `tests/unit/test_sizing.py`: ì£¼ë¬¸ ì‚¬ì´ì§• ìœ í‹¸ë¦¬í‹° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

---

## 20. âœï¸ ë°ì´í„° íë¦„ ìš”ì•½

### âœï¸ ë§¤ë§¤ ë£¨í”„ (ì½¤ë³´ ê¸°ë°˜)
```
[TradingEngine]
    â”œâ”€â”€ [KlineWsManager] â”€â”€â”€â”€ WebSocket 1m ìº”ë“¤ ìˆ˜ì‹  â†’ CandleStore ì €ì¥
    â”‚
    â”œâ”€â”€ [AccountTrader #1] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ asyncio Task
    â”‚       â”‚
    â”‚       â”œâ”€â”€ [PriceCollector] â† WS ìºì‹œ â†’ REST í´ë°±
    â”‚       â”œâ”€â”€ [GlobalRateLimiter] â† API í˜¸ì¶œ ì†ë„ ì œí•œ
    â”‚       â”œâ”€â”€ [BuyPauseManager] â† ì”ê³  ë¶€ì¡± ì—¬ë¶€ íŒë‹¨
    â”‚       â”œâ”€â”€ [BinanceClient] â† ì‹¤ì œ ê±°ë˜ì†Œ API (asyncio.to_thread)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ [Combo #1: LotStackingBuy + FixedTpSell]
    â”‚       â”‚       â”œâ”€â”€ BaseBuyLogic.pre_tick() + tick()
    â”‚       â”‚       â”‚       â”œâ”€â”€ StrategyStateStore (scope=combo_id_1)
    â”‚       â”‚       â”‚       â””â”€â”€ LotRepository
    â”‚       â”‚       â””â”€â”€ BaseSellLogic.tick(buy_lots)
    â”‚       â”‚               â””â”€â”€ ExchangeClient (ìµì ˆ ë§¤ë„ ì£¼ë¬¸)
    â”‚       â”‚
    â”‚       â””â”€â”€ [Combo #2: TrendBuy + FixedTpSell]
    â”‚               â””â”€â”€ StrategyStateStore (scope=combo_id_2) â† ê²©ë¦¬ëœ ìƒíƒœ
    â”‚
    â”œâ”€â”€ [AccountTrader #2] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë…ë¦½ asyncio Task
    â””â”€â”€ [AccountTrader #N] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ...
```

### ğŸ†• WebSocket ìº”ë“¤ íë¦„
```
Binance WebSocket (kline stream)
    â†’ KlineWsManager.multiplex_socket
        â†’ ìº”ë“¤ closed ì´ë²¤íŠ¸
            â†’ CandleStore.store_closed_candle_1m() â†’ DB price_candles_1m
            â†’ PriceCollector ìºì‹œ ê°±ì‹ 

CandleAggregator (6ì‹œê°„ ì£¼ê¸°)
    â†’ 1m â†’ 5m (7ì¼) â†’ DB price_candles_5m
    â†’ 5m â†’ 1h (30ì¼) â†’ DB price_candles_1h
    â†’ 1h â†’ 1d (90ì¼) â†’ DB price_candles_1d
```

### âœï¸ ì¸ì¦ íë¦„ (ë¡œì»¬ DB)
```
ì‚¬ìš©ì â†’ /login â†’ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
    â†’ POST /api/auth/login
        â†’ AuthService.authenticate(email, password)
            â†’ user_profiles í…Œì´ë¸”ì—ì„œ bcrypt.verify()
        â†’ SessionManager.create_session_cookie(uid, email, role)
            â†’ itsdangerous: uid/email/roleì„ ì„œëª…ëœ ì¿ í‚¤ë¡œ ì¸ì½”ë”©
        â†’ Set-Cookie (httponly, secure, samesite=lax)
    â†’ /accounts ë¦¬ë‹¤ì´ë ‰íŠ¸

ì´í›„ ëª¨ë“  ìš”ì²­:
    LazyAuthMiddleware â†’ ì¿ í‚¤ì—ì„œ ì„¸ì…˜ í† í° ì¶”ì¶œ
    â†’ itsdangerous ì„œëª… ê²€ì¦ + ë§Œë£Œ í™•ì¸
    â†’ request.state.userì— ì£¼ì…
```

### âœï¸ ë³´ì•ˆ ê³„ì¸µ
```
1. ì•”í˜¸í™”: API í‚¤ â†’ MultiFernet ì•”í˜¸í™” â†’ DB ì €ì¥
2. ì¸ì¦: ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ â†’ bcrypt ê²€ì¦ â†’ ì„œëª…ëœ ì¿ í‚¤ ì„¸ì…˜ (ë¡œì»¬ DB)
3. ê¶Œí•œ: owner_id í™•ì¸ (ë³¸ì¸ ê³„ì •ë§Œ) + role í™•ì¸ (admin ì „ìš© ê¸°ëŠ¥)
4. CSRF: starlette-csrf ë¯¸ë“¤ì›¨ì–´ â†’ SSR POST ìš”ì²­ì— í† í° ìš”êµ¬
5. ì†ë„ ì œí•œ: GlobalRateLimiter â†’ ë°”ì´ë‚¸ìŠ¤ API 1000 weight/ë¶„
6. ì¥ì•  ê²©ë¦¬: ì„œí‚· ë¸Œë ˆì´ì»¤ â†’ 5íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ ê³„ì • ìë™ ë¹„í™œì„±í™”
7. ë§¤ìˆ˜ ë³´í˜¸: BuyPauseManager â†’ ì”ê³  ë¶€ì¡± ì‹œ ìë™ ì¼ì‹œì •ì§€
```
