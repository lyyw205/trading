# 운영 전 테스트 & 최적화 계획서

> 작성일: 2026-02-26

---

## 목차

1. [Egress 최적화 (긴급)](#1-egress-최적화-긴급)
2. [운영 모니터링 체계](#2-운영-모니터링-체계)
3. [E2E 테스트](#3-e2e-테스트)
4. [DB 비용 최적화](#4-db-비용-최적화)
5. [운영 전 체크리스트](#5-운영-전-체크리스트)
6. [추천 MCP & 스킬](#6-추천-mcp--스킬)

---

## 1. Egress 최적화 (긴급)

코드 분석 결과 **6개 Egress 핫스팟**을 발견. 그 중 2개는 심각도 HIGH로 운영 전 반드시 수정 필요.

### 1-1. [HIGH] `recompute_from_fills` — 매 사이클 전체 체결 이력 풀스캔

**위치**: `app/db/position_repo.py:63`
**문제**: 매 60초 사이클마다 `SELECT * FROM fills WHERE account_id = $1 AND symbol = $2` 실행. `raw_json` 컬럼(400~600 bytes/row) 포함 전체 로우를 앱으로 전송.

**Egress 추정**:
```
계정 5개 × 900 fills(90일) × ~600 bytes = 2.7 MB/분 = 3.9 GB/일
```

**해결 방안**:
- A안 (권장): Fill 삽입 시점에 position을 증분 업데이트. `recompute_from_fills`를 핫 루프에서 제거.
- B안: `last_recomputed_fill_id`를 position 테이블에 저장, 이후 새 fill만 SELECT.
- C안 (최소): SELECT 컬럼에서 `raw_json` 제외, 필요 컬럼만 조회.

**담당**: `executor` 에이전트
**우선순위**: P0 (운영 전 필수)

---

### 1-2. [HIGH] `_get_loop_interval()` — 불필요한 DB 세션 추가 오픈

**위치**: `app/services/account_trader.py:355-359`
**문제**: `step()` 종료 후 `loop_interval_sec`만 읽기 위해 새 DB 세션을 열어 전체 `TradingAccount` 행을 다시 조회. `step()` 안에서 이미 동일 데이터를 로드한 상태.

**Egress 추정**:
```
계정 N개 × 매분 1회 × ~1KB(암호화 키 포함) = 7,200 불필요 쿼리/일
```

**해결 방안**: `step()` 실행 결과로 `loop_interval_sec`를 반환하거나 인스턴스 변수에 캐시.

**담당**: `executor` 에이전트
**우선순위**: P0 (운영 전 필수)

---

### 1-3. [MEDIUM] StrategyStateStore — 키별 개별 쿼리 (10~13회/콤보/사이클)

**위치**: `app/strategies/state_store.py:22-30`
**문제**: `state.get("base_price")`, `state.get("pending_order_id")` 등 키마다 별도 SELECT 실행.

**Egress 추정**:
```
3계정 × 2콤보 × 12쿼리 = 72 불필요 쿼리/분
```

**해결 방안**: 틱 시작 시 `get_all()`로 전체 로드 → 딕셔너리 캐시 → 변경분만 write.

**담당**: `executor` 에이전트
**우선순위**: P1 (운영 초기 적용)

---

### 1-4. [MEDIUM] Dashboard 캔들 API — 범위 제한 없음

**위치**: `app/api/dashboard.py`
**문제**: `from_ms~to_ms` 범위에 상한 없음. 30일 1m 캔들 요청 시 43,200 rows × 80bytes = 3.5 MB/응답.

**해결 방안**: interval별 최대 범위 제한 (1m: 7일, 5m: 30일, 1h: 90일, 1d: 365일) + `.limit(N)` 추가.

**담당**: `executor` 에이전트
**우선순위**: P1

---

### 1-5. [MEDIUM] 백테스트 캔들 로드 — 쿼리 레벨 LIMIT 부재

**위치**: `backtest/isolated_runner.py:278`
**문제**: `MAX_CANDLES = 100,000` 제한은 Python에서 수행. DB는 초과분까지 스트리밍 후 버림.

**해결 방안**: SQL 쿼리에 `.limit(MAX_CANDLES)` 추가.

**담당**: `executor` 에이전트
**우선순위**: P2

---

### 1-6. [LOW] Admin Overview — 유저 카운트에 SELECT * 사용

**위치**: `app/api/admin.py:39-41`
**문제**: `SELECT * FROM user_profiles` 후 `len()` 호출. `SELECT count(*)` 로 교체.

**담당**: `executor` 에이전트
**우선순위**: P2

---

### Egress 안전 확인 (수정 불필요)

| 항목 | 이유 |
|------|------|
| `candle_store.aggregate_candles` | 서버사이드 `INSERT...SELECT`. 앱 egress 없음 |
| `kline_ws_manager._run_multiplex` | Write-only. DB 읽기 없음 |
| `kline_ws_manager._run_backfill` | 재연결 시 60행 쓰기. 빈도 낮음 |
| `lot_repo.get_open_lots_by_combo` | 범위 한정 (account+symbol+combo+OPEN). 일반적으로 <50행 |
| `candle_aggregator.run_once` | 6시간 1회. 메타데이터 쿼리만 앱 전송 |

---

## 2. 운영 모니터링 체계

### 2-1. 알림 시스템 (P0)

| 이벤트 | 알림 채널 | 구현 방법 |
|--------|-----------|-----------|
| Circuit breaker 발동 | Telegram/Discord | `_disable_with_circuit_breaker()`에 웹훅 호출 추가 |
| Buy Pause → PAUSED 전환 | Telegram/Discord | `BuyPauseManager.update_state()`에 알림 |
| WS 연결 끊김 | Telegram/Discord | `_supervisor_loop()` except 블록에 알림 |
| 백테스트 완료/실패 | Telegram/Discord | `_save_results()` / `_save_failure()`에 알림 |

**도구**: `/oh-my-claudecode:configure-telegram` 스킬 또는 `mcp-telegram` MCP 서버

### 2-2. Health Endpoint 강화 (P1)

현재 `/health`에 추가할 항목:
- `kline_ws.healthy`: WebSocket 연결 상태
- `kline_ws.subscribed_symbols`: 구독 중인 심볼 수
- `candle_aggregator.last_run_at`: 마지막 집계 시각
- `buy_pause_summary`: 계정별 pause 상태 요약

### 2-3. 관찰 가능성 스택 (P2, 선택)

| 레벨 | 도구 | 용도 |
|------|------|------|
| 에러 추적 | Sentry | Unhandled exception 자동 리포트 |
| 메트릭 | Prometheus + Grafana | API 응답시간, DB 쿼리 수, 캔들 수집률 |
| 로그 | Supabase Logs / Loki | 구조화 로그 집계 |

---

## 3. E2E 테스트

### Phase 1: 핵심 로직 단위 테스트 (P0)

| 테스트 대상 | 파일 | 케이스 | 도구 |
|-------------|------|--------|------|
| BuyPauseManager 상태 전이 | `test_buy_pause.py` | ACTIVE→THROTTLED→PAUSED→ACTIVE 전체 전이, should_attempt_buy 반환값 | `test-engineer` |
| StrategyStateStore 배치 읽기 | `test_state_store.py` | get_all() vs 개별 get() 동치성 | `test-engineer` |
| CandleStore 저장/조회 | `test_candle_store.py` | 1m 저장 → 5m 집계 → 조회 정합성 | `test-engineer` |
| BacktestClient 시뮬레이션 | `test_backtest_client.py` | 매수→매도→잔고 계산 정확성 | `test-engineer` |
| Sizing 유틸리티 | `test_sizing.py` | 경계값 (min_notional, step_size 반올림) | 기존 테스트 보강 |

### Phase 2: API 통합 테스트 (P1)

| 시나리오 | 엔드포인트 흐름 | 도구 |
|----------|----------------|------|
| 인증 전체 흐름 | POST login → GET me → POST logout | `test-engineer` (pytest + httpx) |
| 계정+콤보 CRUD | POST account → POST combo → PUT combo → DELETE | `test-engineer` |
| 백테스트 비동기 | POST run → GET status (polling) → GET report | `test-engineer` |
| 튜닝 변경 적용 | POST tune → GET tune → 전략 state 확인 | `test-engineer` |
| 권한 검증 | 일반 유저 → admin API 접근 → 403 확인 | `test-engineer` |

### Phase 3: UI E2E 테스트 (P2)

| 시나리오 | 도구 |
|----------|------|
| 로그인 → 대시보드 렌더링 확인 | `mcp__playwright` (navigate → snapshot → screenshot) |
| 차트 로딩 + 타임프레임 전환 | `mcp__playwright` (click → wait_for → snapshot) |
| 튜닝 폼 제출 (CSRF 포함) | `mcp__playwright` (fill_form → click → verify) |
| 백테스트 실행 → 결과 페이지 | `mcp__playwright` (navigate → fill → click → wait_for) |

### Phase 4: 부하 테스트 (P3, 선택)

| 시나리오 | 도구 |
|----------|------|
| 동시 5계정 × 2콤보 매매 루프 | `locust-mcp-server` 또는 `k6-mcp-server` |
| 동시 3 백테스트 실행 | `locust-mcp-server` |
| 대시보드 10명 동시 접속 | `k6-mcp-server` |

---

## 4. DB 비용 최적화

### 4-1. 쿼리 최적화 점검

| 점검 항목 | 방법 | 도구 |
|-----------|------|------|
| 느린 쿼리 Top 10 | `pg_stat_statements` | `mcp__supabase__execute_sql` 또는 `postgres-mcp` |
| 미사용 인덱스 | `pg_stat_user_indexes` (idx_scan = 0) | `mcp__supabase__get_advisors(type="performance")` |
| 테이블 크기 순위 | `pg_total_relation_size()` | `mcp__supabase__execute_sql` |
| Dead tuple 비율 | `pg_stat_user_tables.n_dead_tup` | `postgres-mcp` (`analyze_db_health`) |
| VACUUM 상태 | `last_autovacuum` 시각 확인 | `postgres-mcp` |

### 4-2. 캔들 테이블 관리

| 테이블 | 예상 크기 (10심볼 기준) | 보존 기간 | 비고 |
|--------|-------------------------|-----------|------|
| `price_candles_1m` | ~100K rows/주 | 7일 | 가장 빠르게 성장. 집계 후 삭제 검증 필수 |
| `price_candles_5m` | ~20K rows/주 | 30일 | |
| `price_candles_1h` | ~1.7K rows/주 | 90일 | |
| `price_candles_1d` | ~70 rows/주 | 무제한 | |

**검증 항목**:
- [ ] `CandleAggregator.run_once()` 실행 후 1m 행 수 감소 확인
- [ ] 집계 후 데이터 정합성 (1m 60개 평균 == 1h 1개 값)
- [ ] 7일 이상 된 1m 캔들이 실제 삭제되는지 확인

### 4-3. 커넥션 풀 최적화

현재: `pool_size=30, max_overflow=10` (총 40 커넥션 가능)

| 소비자 | 예상 동시 사용 | 비고 |
|--------|---------------|------|
| AccountTrader × N | N개 (계정 수) | 가장 큰 소비자 |
| KlineWsManager | 1~2개 | 캔들 저장 시 순간 사용 |
| CandleAggregator | 1개 | 6시간 1회 |
| API 요청 | 2~5개 | 대시보드 + 관리자 |
| 백테스트 | 1~3개 | 동시 3개 제한 |

**결론**: 계정 10개까지는 `pool_size=30`이면 충분. 20개 이상 시 재검토 필요.

---

## 5. 운영 전 체크리스트

### Must-have (운영 전 필수)

- [ ] **P0** Egress 핫스팟 #1 수정 (recompute_from_fills 증분 업데이트)
- [ ] **P0** Egress 핫스팟 #2 수정 (_get_loop_interval 캐시)
- [ ] **P0** 알림 시스템 구현 (최소 circuit breaker + buy pause 알림)
- [ ] **P0** 핵심 로직 단위 테스트 (BuyPause, CandleStore, BacktestClient)
- [ ] **P0** DB 마이그레이션 001~008 클린 적용 검증
- [ ] **P0** 보안 리뷰 (API 키 노출, SQL injection, XSS, CSRF 우회)
- [ ] **P0** 환경 변수 검증 (.env.example과 실제 필요 변수 일치)
- [ ] **P0** Graceful shutdown 테스트 (SIGTERM → WS/트레이딩/집계 정상 종료)

### Should-have (운영 초기 1주 내)

- [ ] **P1** Egress 핫스팟 #3 수정 (StrategyStateStore 배치 읽기)
- [ ] **P1** Egress 핫스팟 #4 수정 (대시보드 캔들 범위 제한)
- [ ] **P1** API 통합 테스트 작성
- [ ] **P1** Health endpoint 강화 (WS 상태, 집계 상태)
- [ ] **P1** 캔들 집계 정합성 검증
- [ ] **P1** WS 재연결 → 백필 → 재수신 흐름 테스트
- [ ] **P1** Circuit breaker 실동작 테스트 (5회 실패 → 비활성화 → 리셋)
- [ ] **P1** Rate limit 테스트 (계정 10개 동시 시 API 가중치)

### Nice-to-have (운영 안정화 후)

- [ ] **P2** Egress 핫스팟 #5, #6 수정
- [ ] **P2** UI E2E 테스트 (Playwright)
- [ ] **P2** DB 성능 베이스라인 기록 (EXPLAIN ANALYZE 주요 쿼리)
- [ ] **P2** Sentry 통합
- [ ] **P2** 백업 전략 + 복원 테스트
- [ ] **P3** 부하 테스트 (locust/k6)
- [ ] **P3** Prometheus + Grafana 메트릭
- [ ] **P3** DB 파티셔닝 (candles_1m 날짜별)

---

## 6. 추천 MCP & 스킬

### 즉시 설치 권장 (운영 핵심)

| 도구 | 유형 | 용도 | 설치 |
|------|------|------|------|
| **crystaldba/postgres-mcp** | MCP 서버 | DB 쿼리 최적화, 인덱스 추천, 헬스체크 | `npx @crystaldba/postgres-mcp` |
| **getsentry/sentry-mcp** | MCP 서버 | 에러 추적, 이슈 검색 | `claude mcp add --transport http sentry https://mcp.sentry.dev/mcp` |
| **mcp-telegram** | MCP 서버 | 트레이딩 알림 (circuit breaker, buy pause 등) | `github.com/antongsm/mcp-telegram` |

### 테스트 시 설치 권장

| 도구 | 유형 | 용도 | 설치 |
|------|------|------|------|
| **call518/MCP-PostgreSQL-Ops** | MCP 서버 | 커넥션 모니터링, 블로트 분석, VACUUM 상태 | `github.com/call518/MCP-PostgreSQL-Ops` |
| **QAInsights/locust-mcp-server** | MCP 서버 | Python 부하 테스트 | `github.com/QAInsights/locust-mcp-server` |
| **grafana/mcp-grafana** | MCP 서버 | 메트릭 대시보드 + 알림 규칙 관리 | `uvx mcp-grafana` |

### 스킬 저장소 (참고용)

| 저장소 | URL | 비고 |
|--------|-----|------|
| **SkillHub** | `skillhub.club` | 22,000+ 커뮤니티 스킬. CLI: `npx @skill-hub/cli search "postgres"` |
| **awesome-claude-code** | `github.com/hesreallyhim/awesome-claude-code` | 큐레이션된 스킬/플러그인 목록 |
| **awesome-agent-skills** | `github.com/VoltAgent/awesome-agent-skills` | 380+ 에이전트 스킬 (supabase/postgres-best-practices 포함) |
| **Anthropic Skills** | `github.com/anthropics/skills` | 공식 스킬 저장소 |

### 유용한 커뮤니티 스킬

| 스킬 | 출처 | 용도 |
|------|------|------|
| `supabase/postgres-best-practices` | awesome-agent-skills | Supabase PostgreSQL 최적화 가이드 |
| `trailofbits/modern-python` | awesome-agent-skills | Python 도구(ruff, pytest) 모범 사례 |
| `getsentry/find-bugs` | awesome-agent-skills | 버그 탐지 |
| `getsentry/code-review` | awesome-agent-skills | 코드 리뷰 |

---

## 실행 순서 요약

```
Phase 0 (즉시) — Egress 긴급 수정
  ├── #1 recompute_from_fills 증분 업데이트
  ├── #2 _get_loop_interval 캐시
  └── #6 admin overview SELECT count(*)

Phase 1 (1~2일) — 안전망 구축
  ├── 알림 시스템 (Telegram 웹훅)
  ├── 핵심 단위 테스트 작성
  ├── 보안 리뷰
  └── DB 마이그레이션 검증

Phase 2 (3~5일) — 통합 검증
  ├── #3 StrategyStateStore 배치 읽기
  ├── #4 대시보드 캔들 범위 제한
  ├── API 통합 테스트
  ├── Health endpoint 강화
  └── Graceful shutdown 테스트

Phase 3 (운영 후 1주) — 모니터링 강화
  ├── postgres-mcp로 DB 성능 베이스라인
  ├── Sentry 통합
  ├── UI E2E 테스트
  └── 캔들 집계 정합성 검증

Phase 4 (운영 안정화 후) — 고도화
  ├── Prometheus + Grafana
  ├── 부하 테스트
  └── DB 파티셔닝 검토
```
