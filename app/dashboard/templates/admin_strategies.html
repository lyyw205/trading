{% extends "base.html" %}

{% block title %}Strategies - Crypto Multi-Trader{% endblock %}

{% block content %}
<style>
.dashboard-section {
  background: none;
  border: none;
  box-shadow: none;
  padding: 0;
}
.strategy-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
}
.strategy-card-name {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text);
  font-family: var(--font-mono);
}
.strategy-card-display {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 0.1rem;
}
.strategy-card-desc {
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.55;
  margin-top: 0.75rem;
}
.strategy-card-footer {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-top: 0.75rem;
  padding-top: 0.75rem;
  border-top: 1px solid var(--card-border, var(--border));
  flex-wrap: wrap;
}
.strategy-stat {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  font-size: 0.78rem;
  color: var(--text-muted);
}
.strategy-stat strong {
  color: var(--text);
  font-weight: 700;
}
.strategy-stat svg { width: 14px; height: 14px; flex-shrink: 0; }
.params-toggle {
  margin-left: auto;
  font-size: 0.75rem;
  color: var(--text-muted);
  cursor: pointer;
  border: none;
  background: none;
  padding: 0.15rem 0.4rem;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  transition: color 0.15s, background 0.15s;
}
.params-toggle:hover { color: var(--primary); background: var(--primary-light); }
.params-toggle svg { transition: transform 0.2s; }
.params-toggle.open svg { transform: rotate(180deg); }
.params-list {
  display: none;
  width: 100%;
  padding: 0.4rem 0.65rem;
  background: var(--bg-tertiary);
  border-radius: var(--radius-md, 8px);
  font-size: 0.72rem;
  margin-top: 0.25rem;
}
.params-list.open { display: block; }
.param-row {
  display: flex;
  justify-content: space-between;
  padding: 0.25rem 0;
}
.param-row + .param-row { border-top: 1px solid rgba(255,255,255,0.04); }
.param-key { color: var(--text-muted); font-family: var(--font-mono); }
.param-val { font-weight: 600; color: var(--text); font-family: var(--font-mono); }
</style>

<div class="hero-banner">
  <h1 class="page-title">Strategy Catalog</h1>
  <p class="hero-subtitle">Registered buy & sell strategies with adoption statistics.</p>
</div>

<section class="dashboard-section">
  <div class="section-header">
    <h2 class="section-title">Buy Strategies</h2>
  </div>
  <div class="strategy-grid" id="buy-strategies">
    <div class="table-empty">Loading...</div>
  </div>
</section>

<section class="dashboard-section" style="margin-top:1.5rem;">
  <div class="section-header">
    <h2 class="section-title">Sell Strategies</h2>
  </div>
  <div class="strategy-grid" id="sell-strategies">
    <div class="table-empty">Loading...</div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
function toggleParams(btn) {
  btn.classList.toggle('open');
  btn.nextElementSibling.classList.toggle('open');
}

function renderStrategyCard(s) {
  const isBuy = s.category === 'buy';
  const iconClass = isBuy ? 'kpi-icon-success' : 'kpi-icon-danger';
  const typeLabel = isBuy ? 'BUY' : 'SELL';

  const params = s.default_params || {};
  const paramKeys = Object.keys(params);
  const paramsHtml = paramKeys.length ? `
    <button class="params-toggle" onclick="toggleParams(this)">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
      ${paramKeys.length} defaults
    </button>
    <div class="params-list">
      ${paramKeys.map(k => `<div class="param-row"><span class="param-key">${escapeHtml(k)}</span><span class="param-val">${escapeHtml(String(params[k]))}</span></div>`).join('')}
    </div>` : '';

  return `
    <div class="kpi-card">
      <div class="strategy-card-name">${escapeHtml(s.name)}</div>
      <div class="strategy-card-display">${escapeHtml(s.display_name || '')}</div>
      <div class="strategy-card-desc">${escapeHtml(s.description || 'No description')}</div>
      <div class="strategy-card-footer">
        <div class="strategy-stat">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <strong>${s.adoption_count}</strong> combo${s.adoption_count !== 1 ? 's' : ''}
        </div>
        ${paramsHtml}
      </div>
    </div>`;
}

async function loadStrategies() {
  try {
    const resp = await apiFetch('/api/admin/strategies');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();

    const buyGrid = document.getElementById('buy-strategies');
    const sellGrid = document.getElementById('sell-strategies');

    if (data.buy && data.buy.length) {
      buyGrid.innerHTML = data.buy.map(renderStrategyCard).join('');
    } else {
      buyGrid.innerHTML = '<div class="table-empty">No buy strategies registered</div>';
    }

    if (data.sell && data.sell.length) {
      sellGrid.innerHTML = data.sell.map(renderStrategyCard).join('');
    } else {
      sellGrid.innerHTML = '<div class="table-empty">No sell strategies registered</div>';
    }
  } catch (e) {
    document.getElementById('buy-strategies').innerHTML = '<div class="table-empty error-text">Failed to load: ' + escapeHtml(e.message) + '</div>';
    document.getElementById('sell-strategies').innerHTML = '';
  }
}

document.addEventListener('DOMContentLoaded', loadStrategies);
</script>
{% endblock %}
