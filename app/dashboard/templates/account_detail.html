{% extends "base.html" %}

{% block title %}Account Dashboard - Crypto Multi-Trader{% endblock %}

{% block content %}
<div class="page-header">
  <a href="/accounts" class="back-link">&larr; All Accounts</a>
  <div class="account-header" id="account-header">
    <h1 class="page-title" id="account-label">Loading...</h1>
    <span class="status-badge" id="account-status-badge"></span>
  </div>
</div>

<!-- Section 1: Price Chart -->
<section class="dashboard-section">
  <div class="section-header">
    <h2 class="section-title">Price Chart</h2>
    <span class="section-subtitle" id="chart-symbol"></span>
  </div>
  <div id="price-chart" class="chart-container"></div>
</section>

<!-- Section 2: Asset Status -->
<section class="dashboard-section">
  <div class="section-header">
    <h2 class="section-title">Asset Status</h2>
  </div>
  <div id="asset-status" class="asset-grid">
    <div class="loading-spinner">Loading...</div>
  </div>
</section>

<!-- Section 3: LOT Table -->
<section class="dashboard-section">
  <div class="section-header">
    <h2 class="section-title">Open Lots</h2>
    <div class="filter-tabs" id="lot-filter-tabs">
      <button class="filter-tab active" data-filter="all" onclick="filterLots('all')">All</button>
    </div>
  </div>
  <div class="table-wrapper">
    <table class="data-table" id="lots-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Strategy</th>
          <th>Buy Price</th>
          <th>Qty</th>
          <th>Cost</th>
          <th>Current Price</th>
          <th>P&amp;L%</th>
          <th>Sell Order Status</th>
        </tr>
      </thead>
      <tbody id="lots-tbody">
        <tr><td colspan="8" class="table-empty">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- Section 4: Trading Combos -->
<section class="dashboard-section">
  <div class="section-header">
    <h2 class="section-title">Trading Combos</h2>
    <button class="btn btn-primary btn-sm" onclick="showCreateComboModal()">+ New Combo</button>
  </div>
  <div id="combos-panel">
    <div class="loading-spinner">Loading...</div>
  </div>
</section>

<!-- Combo Create/Edit Modal (5-Step Wizard) -->
<div id="combo-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content modal-wizard">
    <h3 id="combo-modal-title">New Combo</h3>
    <input type="hidden" id="combo-edit-id">

    <!-- Stepper -->
    <div class="wizard-stepper" id="combo-wizard-stepper">
      <div class="wizard-step active" data-step="1" data-color="primary" onclick="comboWizardGoTo(1)">
        <div class="wizard-step-circle">1</div>
        <div class="wizard-step-label">일반</div>
      </div>
      <div class="wizard-connector" data-after="1"></div>
      <div class="wizard-step" data-step="2" data-color="success" onclick="comboWizardGoTo(2)">
        <div class="wizard-step-circle">2</div>
        <div class="wizard-step-label">매수 전략</div>
      </div>
      <div class="wizard-connector" data-after="2"></div>
      <div class="wizard-step" data-step="3" data-color="teal" onclick="comboWizardGoTo(3)">
        <div class="wizard-step-circle">3</div>
        <div class="wizard-step-label">매수 금액</div>
      </div>
      <div class="wizard-connector" data-after="3"></div>
      <div class="wizard-step" data-step="4" data-color="danger" onclick="comboWizardGoTo(4)">
        <div class="wizard-step-circle">4</div>
        <div class="wizard-step-label">매도 전략</div>
      </div>
      <div class="wizard-connector" data-after="4"></div>
      <div class="wizard-step" data-step="5" data-color="orange" onclick="comboWizardGoTo(5)">
        <div class="wizard-step-circle">5</div>
        <div class="wizard-step-label">매도 금액</div>
      </div>
    </div>

    <!-- Wizard Panels -->
    <div class="wizard-body">
      <!-- Step 1: General -->
      <div class="wizard-panel active" data-panel="1">
        <div class="combo-section combo-section-general">
          <div class="combo-section-title">General</div>
          <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" id="combo-name" class="form-input" placeholder="e.g. BTC LOT + Fixed TP">
          </div>
          <div class="form-group" style="margin-top:0.5rem;">
            <label class="form-label">Reference Combo (optional)</label>
            <select id="combo-reference" class="form-input">
              <option value="">None</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Step 2: Buy Strategy (condition params) -->
      <div class="wizard-panel" data-panel="2">
        <div class="combo-section combo-section-buy">
          <div class="combo-section-title">매수 전략</div>
          <div id="combo-buy-logic-group">
            <select id="combo-buy-logic" class="form-input" onchange="renderComboConditionParams('buy')"></select>
          </div>
          <div id="combo-buy-condition-params"></div>
        </div>
      </div>

      <!-- Step 3: Buy Sizing -->
      <div class="wizard-panel" data-panel="3">
        <div class="combo-section combo-section-buy-sizing">
          <div class="combo-section-title">매수 금액</div>
          <div id="combo-buy-sizing-params"></div>
        </div>
      </div>

      <!-- Step 4: Sell Strategy (condition params) -->
      <div class="wizard-panel" data-panel="4">
        <div class="combo-section combo-section-sell">
          <div class="combo-section-title">매도 전략</div>
          <div id="combo-sell-logic-group">
            <select id="combo-sell-logic" class="form-input" onchange="renderComboConditionParams('sell')"></select>
          </div>
          <div id="combo-sell-condition-params"></div>
        </div>
      </div>

      <!-- Step 5: Sell Sizing + Reapply -->
      <div class="wizard-panel" data-panel="5">
        <div class="combo-section combo-section-sell-sizing">
          <div class="combo-section-title">매도 금액</div>
          <div id="combo-sell-sizing-params"></div>
        </div>
        <div id="combo-reapply-group" class="form-group" style="display:none;margin-top:0.75rem;">
          <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
            <input type="checkbox" id="combo-reapply-orders">
            <span style="font-size:0.85rem;">미체결 주문 재등록 (기존 미체결 매수/매도 주문을 취소하고 변경된 값으로 재등록)</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Wizard Navigation -->
    <div class="wizard-nav">
      <button class="btn btn-outline btn-sm btn-wizard-prev" onclick="comboWizardPrev()" style="display:none;">이전</button>
      <button class="btn btn-outline btn-sm" onclick="closeComboModal()">Cancel</button>
      <button class="btn btn-primary btn-sm btn-wizard-next" onclick="comboWizardNext()">다음</button>
      <button class="btn btn-primary btn-sm btn-wizard-save" onclick="saveCombo()" style="display:none;">저장</button>
    </div>
  </div>
</div>

<!-- Buy Plan Calculator Modal -->
<div id="buyplan-calc-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:1100px;max-height:90vh;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h3 style="margin:0;">매수 계획 계산기</h3>
      <button class="btn btn-outline btn-sm" onclick="closeBuyPlanCalc()">닫기</button>
    </div>
    <p style="color:#94a3b8;font-size:0.85rem;margin:0 0 12px;">
      1~5회는 <code>x, 2x, 3x, 4x, 5x</code>, 6회 이후는 5회차 매수금액(A) 근사 유지 규칙으로 계산합니다.
    </p>
    <form id="buyplanCalcForm" onsubmit="event.preventDefault();runBuyPlanCalc();" style="margin-bottom:12px;">
      <div class="tune-grid">
        <div class="form-group">
          <label class="form-label">보유 USDT</label>
          <input id="bp-initialUsdt" type="number" step="0.01" min="0" value="2000" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">x (%)</label>
          <input id="bp-xPct" type="number" step="0.01" min="0.01" max="19.99" value="0.5" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">최소 주문금액 USDT</label>
          <input id="bp-minOrder" type="number" step="0.01" min="0" value="10" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">6회 이후 미리보기</label>
          <input id="bp-preview" type="number" step="1" min="1" max="50" value="10" class="form-input">
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-sm" style="margin-top:8px;">계산하기</button>
    </form>
    <div id="bp-summary" class="asset-grid" style="margin-bottom:12px;"></div>
    <div id="bp-warn" style="color:#dc2626;font-size:0.85rem;display:none;margin-bottom:8px;"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <h4 style="margin:0 0 4px;font-size:0.9rem;">1~5회 예상 매수</h4>
        <table class="data-table" style="font-size:0.8rem;">
          <thead><tr><th>회차</th><th>매수%</th><th>금액</th><th>잔고</th></tr></thead>
          <tbody id="bp-firstFive"></tbody>
        </table>
      </div>
      <div>
        <h4 style="margin:0 0 4px;font-size:0.9rem;">6회 이후 예상 (A 근사 유지)</h4>
        <table class="data-table" style="font-size:0.8rem;">
          <thead><tr><th>회차</th><th>예상%</th><th>금액</th></tr></thead>
          <tbody id="bp-afterFive"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Sections 5 & 6: Status Row -->
<div class="status-row">
  <section class="dashboard-section">
    <div class="section-header">
      <h2 class="section-title">Buy Pause Status</h2>
    </div>
    <div id="buy-pause-panel">
      <div class="loading-spinner">Loading...</div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="section-header">
      <h2 class="section-title">Circuit Breaker</h2>
    </div>
    <div id="circuit-breaker-panel" class="cb-panel">
      <div class="loading-spinner">Loading...</div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
<script>
const ACCOUNT_ID = '{{ account_id }}';

document.addEventListener('DOMContentLoaded', () => {
  loadAccountDashboard(ACCOUNT_ID);
});
</script>
{% endblock %}
