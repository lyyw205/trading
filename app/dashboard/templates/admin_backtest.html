{% extends "base.html" %}

{% block title %}Backtest Lab - Crypto Multi-Trader{% endblock %}

{% block content %}
<style>
/* Stepper */
.stepper { display:flex; align-items:center; gap:0; margin-bottom:1.5rem; padding:0 0.5rem; max-width:480px; }
.step-item { display:flex; align-items:center; gap:0.5rem; cursor:pointer; padding:0.5rem 0.75rem; border-radius:8px; transition:background 0.15s; }
.step-item:hover { background:var(--bg-hover, rgba(0,0,0,0.04)); }
.step-num { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; font-weight:700; border:2px solid var(--border); color:var(--text-muted); background:rgb(245,245,245); transition:all 0.2s; flex-shrink:0; }
.step-item.active .step-num { background:var(--primary); color:#fff; border-color:var(--primary); }
.step-item.done .step-num { background:var(--primary); color:#fff; border-color:var(--primary); }
.step-label { font-size:0.8rem; color:var(--text-muted); white-space:nowrap; }
.step-item.active .step-label { color:var(--text); font-weight:600; }
.step-item.done .step-label { color:var(--primary); }
.step-connector { flex:1; height:2px; background:var(--bg-tertiary, rgba(255,255,255,0.12)); min-width:16px; }
.step-connector.done { background:var(--primary); }

/* Panels */
.step-panel { display:none; }
.step-panel.active { display:flex; flex-direction:column; }
.step-panel .tune-grid { margin-bottom:0; }
.step-panel { min-height:320px; }
.step-nav { margin-top:auto; padding-top:1rem; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }

/* Navigation */
.step-nav .btn { min-width:100px; }

/* Buy logic 2-column layout */
.bt-columns { display:grid; grid-template-columns:1fr 1fr; gap:0; border-radius:8px; overflow:hidden; }
.bt-col { padding:0.75rem; }
.bt-col-sizing { background:rgba(49, 130, 246, 0.06); }
.bt-section-title { font-size:0.8rem; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.75rem; }
.bt-sub-params { padding:0.5rem 0 0; }
@media (max-width:600px) { .bt-columns { grid-template-columns:1fr; } }

/* Review summary */
.review-item { display:flex; justify-content:space-between; padding:0.25rem 0; font-size:0.875rem; }
.review-item .label { color:var(--text-muted); }
.review-item .value { font-weight:600; }
.review-params-toggle { display:flex; align-items:center; gap:0.25rem; font-size:0.75rem; color:var(--text-muted); cursor:pointer; border:none; background:none; padding:0.35rem 0; transition:color 0.15s; }
.review-params-toggle:hover { color:var(--primary); }
.review-params-toggle svg { width:14px; height:14px; transition:transform 0.2s; }
.review-params-toggle.open svg { transform:rotate(180deg); }
.review-params-body { display:none; padding:0.25rem 0; }
.review-params-body.open { display:block; }

/* History */
.pnl-positive { color:var(--success); font-weight:600; }
.pnl-negative { color:var(--danger); font-weight:600; }
.badge-neutral { background:rgba(100,116,139,0.12); color:#64748b; }
.badge-pinned { background:rgba(240,185,11,0.12); color:#f0b90b; font-size:0.7rem; font-weight:600; padding:2px 6px; border-radius:4px; margin-left:0.35rem; }
.tf-selector { display:flex; gap:0.25rem; }
.tf-btn { padding:0.25rem 0.5rem; font-size:0.72rem; font-weight:600; border:1px solid var(--border); border-radius:6px; background:transparent; color:var(--text-muted); cursor:pointer; transition:all 0.15s; }
.tf-btn:hover { color:var(--text); border-color:var(--text-muted); }
.tf-btn.active { background:var(--primary); color:#fff; border-color:var(--primary); }
</style>

<div class="hero-banner">
  <h1 class="page-title">Backtest Lab</h1>
  <p class="hero-subtitle">Configure and run strategy backtests.</p>
</div>

<section class="dashboard-section">
  <!-- Stepper -->
  <div class="stepper" id="stepper">
    <div class="step-item active" onclick="goToStep(1)">
      <span class="step-num">1</span><span class="step-label">Settings</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-item" onclick="goToStep(2)">
      <span class="step-num">2</span><span class="step-label">Strategy</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-item" onclick="goToStep(3)">
      <span class="step-num">3</span><span class="step-label">Run</span>
    </div>
  </div>

  <form id="backtest-form" onsubmit="return false;">
    <!-- Step 1: Settings (Market + Period) -->
    <div class="step-panel active" data-step="1">
      <div class="bt-columns">
        <div class="bt-col">
          <div class="bt-section-title">Market</div>
          <div class="tune-grid">
            <div class="form-group">
              <label class="form-label">Symbol</label>
              <select id="bt-symbol" class="form-input">
                <option value="BTCUSDT" selected>BTCUSDT</option>
                <option value="ETHUSDT">ETHUSDT</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Initial USDT</label>
              <input type="number" step="100" id="bt-initial-usdt" class="form-input" value="10000">
            </div>
          </div>
        </div>
        <div class="bt-col bt-col-sizing">
          <div class="bt-section-title">Period</div>
          <div class="tune-grid">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" id="bt-start-date" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" id="bt-end-date" class="form-input">
            </div>
          </div>
        </div>
      </div>
      <div class="step-nav">
        <div></div>
        <button type="button" class="btn btn-primary" onclick="goToStep(2)">Next</button>
      </div>
    </div>

    <!-- Step 2: Strategy (Buy + Sell) -->
    <div class="step-panel" data-step="2">
      <div class="bt-columns">
        <div class="bt-col">
          <div class="bt-section-title">Buy Logic</div>
          <div class="form-group" style="margin-bottom:0;">
            <select class="form-input" id="bt-buy-logic" onchange="onBtBuyLogicChange()"></select>
          </div>
          <div class="bt-sub-params" id="bt-buy-cond-params" style="display:none;"></div>
        </div>
        <div class="bt-col bt-col-sizing">
          <div class="bt-section-title">Buy Sizing</div>
          <div class="form-group" style="margin-bottom:0;">
            <select class="form-input" id="bt-sizing-mode" data-bt-side="buy" data-param="sizing_mode" data-type="select" onchange="onBtSizingChange()" disabled>
              <option disabled selected>Select buy logic first</option>
            </select>
          </div>
          <div class="bt-sub-params" id="bt-buy-sizing-params" style="display:none;"></div>
        </div>
      </div>
      <div class="bt-columns" style="margin-top:0.5rem;">
        <div class="bt-col">
          <div class="bt-section-title">Sell Logic</div>
          <div class="bt-sub-params" id="bt-sell-params" style="display:none;"></div>
        </div>
        <div class="bt-col bt-col-sizing">
          <div class="bt-section-title">Sell Sizing</div>
          <div class="form-group" style="margin-bottom:0;">
            <select class="form-input" id="bt-sell-logic" onchange="onBtSellLogicChange()"></select>
          </div>
          <div class="bt-sub-params" id="bt-sell-sizing-params" style="display:none;"></div>
        </div>
      </div>
      <div class="step-nav">
        <button type="button" class="btn btn-outline" onclick="goToStep(1)">Back</button>
        <button type="button" class="btn btn-primary" onclick="goToStep(3)">Next</button>
      </div>
    </div>

    <!-- Step 3: Review & Run -->
    <div class="step-panel" data-step="3">
      <div class="bt-columns" id="review-summary"></div>
      <div class="step-nav">
        <button type="button" class="btn btn-outline" onclick="goToStep(2)">Back</button>
        <button type="button" class="btn btn-primary" id="bt-run-btn" onclick="startBacktest()">Run Backtest</button>
      </div>
    </div>
  </form>
</section>

<!-- History -->
<section class="dashboard-section" style="margin-top:1.5rem;">
  <div class="section-header">
    <h2 class="section-title">History</h2>
    <div style="display:flex; gap:0.5rem; align-items:center;">
      <div class="tf-selector" id="bt-history-filter">
        <button class="tf-btn active" data-filter="all" onclick="filterHistory('all', this)">All</button>
        <button class="tf-btn" data-filter="pinned" onclick="filterHistory('pinned', this)">Pinned</button>
      </div>
      <button class="btn btn-outline btn-sm" onclick="loadBacktestHistory()">Refresh</button>
    </div>
  </div>
  <div class="table-wrapper">
    <table class="data-table" id="backtest-history-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Symbol</th>
          <th>Strategy</th>
          <th>Period</th>
          <th>PnL %</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="backtest-history-tbody">
        <tr><td colspan="7" class="table-empty">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
let _backtestPollTimer = null;
let _btBuyLogics = [];
let _btSellLogics = [];
let _currentStep = 1;
let _historyFilter = 'all';
let _historyData = [];

// ============================================================
//  Stepper Navigation
// ============================================================
function goToStep(step) {
  if (step < 1 || step > 3) return;
  _currentStep = step;

  document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
  const panel = document.querySelector(`.step-panel[data-step="${step}"]`);
  if (panel) panel.classList.add('active');

  const items = document.querySelectorAll('.step-item');
  const connectors = document.querySelectorAll('.step-connector');
  items.forEach((item, i) => {
    const s = i + 1;
    item.classList.remove('active', 'done');
    if (s === step) item.classList.add('active');
    else if (s < step) item.classList.add('done');
  });
  connectors.forEach((c, i) => {
    c.classList.toggle('done', i + 1 < step);
  });

  if (step === 3) buildReview();
}

// ============================================================
//  Load Logics
// ============================================================
async function loadBtLogics() {
  try {
    const [buyResp, sellResp] = await Promise.all([
      apiFetch('/api/buy-logics'),
      apiFetch('/api/sell-logics'),
    ]);
    if (buyResp.ok) _btBuyLogics = await buyResp.json();
    if (sellResp.ok) _btSellLogics = await sellResp.json();

    // Populate buy dropdown
    const buyEl = document.getElementById('bt-buy-logic');
    buyEl.innerHTML = _btBuyLogics.map(b =>
      `<option value="${b.name}">${escapeHtml(b.display_name)}</option>`
    ).join('');
    onBtBuyLogicChange();

    // Populate sell dropdown
    const sellEl = document.getElementById('bt-sell-logic');
    sellEl.innerHTML = _btSellLogics.map(s =>
      `<option value="${s.name}">${escapeHtml(s.display_name)}</option>`
    ).join('');
    onBtSellLogicChange();
  } catch (e) {
    console.error('Failed to load logics', e);
  }
}

// ============================================================
//  Buy Logic change
// ============================================================
function onBtBuyLogicChange() {
  const selEl = document.getElementById('bt-buy-logic');
  if (!selEl) return;
  const meta = _btBuyLogics.find(l => l.name === selEl.value);
  const condContainer = document.getElementById('bt-buy-cond-params');
  const sizingSelect = document.getElementById('bt-sizing-mode');
  const sizingContainer = document.getElementById('bt-buy-sizing-params');

  if (!meta) {
    if (condContainer) { condContainer.innerHTML = ''; condContainer.style.display = 'none'; }
    if (sizingSelect) { sizingSelect.innerHTML = '<option disabled>N/A</option>'; sizingSelect.disabled = true; }
    if (sizingContainer) { sizingContainer.innerHTML = ''; sizingContainer.style.display = 'none'; }
    return;
  }

  const tunableParams = meta.tunable_params || {};
  const defaults = meta.default_params || {};
  const condParams = {};
  const sizingSubParams = {};
  let sizingModeSpec = null;
  for (const [key, spec] of Object.entries(tunableParams)) {
    if (key === 'sizing_mode' && spec.group === 'sizing') { sizingModeSpec = spec; }
    else if (spec.group === 'sizing') { sizingSubParams[key] = spec; }
    else { condParams[key] = spec; }
  }

  const commonOpts = {
    defaults, current: {}, side: 'buy',
    inputId: (key) => `bt-buy-${key}`,
    dataAttrs: (key) => `data-bt-side="buy"`,
    onToggle: () => `toggleBtBuyDeps(this)`,
    showUnit: true,
  };

  // Condition params
  if (condContainer) {
    if (Object.keys(condParams).length > 0) {
      condContainer.innerHTML = _renderParamsHtml({ ...commonOpts, tunableParams: condParams });
      condContainer.style.display = 'block';
    } else {
      condContainer.innerHTML = '';
      condContainer.style.display = 'none';
    }
  }

  // Sizing mode dropdown
  if (sizingSelect && sizingModeSpec) {
    const curVal = defaults.sizing_mode || sizingModeSpec.options[0].value;
    sizingSelect.innerHTML = sizingModeSpec.options.map(o =>
      `<option value="${o.value}" ${o.value === curVal ? 'selected' : ''}>${escapeHtml(o.label)}</option>`
    ).join('');
    sizingSelect.disabled = false;
    onBtSizingChange();
  } else if (sizingSelect) {
    sizingSelect.innerHTML = '<option disabled selected>No sizing options</option>';
    sizingSelect.disabled = true;
    if (sizingContainer) { sizingContainer.innerHTML = ''; sizingContainer.style.display = 'none'; }
  }
}

// ============================================================
//  Sizing mode change
// ============================================================
function onBtSizingChange() {
  const sizingSelect = document.getElementById('bt-sizing-mode');
  const sizingContainer = document.getElementById('bt-buy-sizing-params');
  const buyEl = document.getElementById('bt-buy-logic');
  if (!sizingSelect || !sizingContainer || !buyEl) return;

  const meta = _btBuyLogics.find(l => l.name === buyEl.value);
  if (!meta) { sizingContainer.innerHTML = ''; sizingContainer.style.display = 'none'; return; }

  const tunableParams = meta.tunable_params || {};
  const defaults = meta.default_params || {};
  const sizingSubParams = {};
  for (const [key, spec] of Object.entries(tunableParams)) {
    if (spec.group === 'sizing' && key !== 'sizing_mode') sizingSubParams[key] = spec;
  }

  if (Object.keys(sizingSubParams).length > 0) {
    sizingContainer.innerHTML = _renderParamsHtml({
      tunableParams: sizingSubParams, defaults, current: {}, side: 'buy',
      inputId: (key) => `bt-buy-${key}`,
      dataAttrs: (key) => `data-bt-side="buy"`,
      onToggle: () => `toggleBtBuyDeps(this)`,
      showUnit: true,
    });
    _toggleDeps(sizingContainer, 'sizing_mode', sizingSelect.value);
    sizingContainer.style.display = 'block';
  } else {
    sizingContainer.innerHTML = '';
    sizingContainer.style.display = 'none';
  }
}

function toggleBtBuyDeps(selectEl) {
  const c = document.getElementById('bt-buy-cond-params');
  const s = document.getElementById('bt-buy-sizing-params');
  if (c) _toggleDeps(c, selectEl.dataset.param, selectEl.value);
  if (s) _toggleDeps(s, selectEl.dataset.param, selectEl.value);
}

// ============================================================
//  Sell Logic change
// ============================================================
function onBtSellLogicChange() {
  const selEl = document.getElementById('bt-sell-logic');
  const condContainer = document.getElementById('bt-sell-params');
  const sizingContainer = document.getElementById('bt-sell-sizing-params');
  if (!selEl) return;
  const meta = _btSellLogics.find(l => l.name === selEl.value);

  if (!meta) {
    if (condContainer) { condContainer.innerHTML = ''; condContainer.style.display = 'none'; }
    if (sizingContainer) { sizingContainer.innerHTML = ''; sizingContainer.style.display = 'none'; }
    return;
  }

  const tunableParams = meta.tunable_params || {};
  const defaults = meta.default_params || {};
  const condParams = {};
  const sizingParams = {};
  for (const [key, spec] of Object.entries(tunableParams)) {
    if (spec.group === 'sizing') sizingParams[key] = spec;
    else condParams[key] = spec;
  }

  const commonOpts = {
    defaults, current: {}, side: 'sell',
    inputId: (key) => `bt-sell-${key}`,
    dataAttrs: (key) => `data-bt-side="sell"`,
    onToggle: () => `toggleBtSellDeps(this)`,
    showUnit: true,
  };

  if (condContainer) {
    if (Object.keys(condParams).length > 0) {
      condContainer.innerHTML = _renderParamsHtml({ ...commonOpts, tunableParams: condParams });
      condContainer.style.display = 'block';
    } else {
      condContainer.innerHTML = '';
      condContainer.style.display = 'none';
    }
  }

  if (sizingContainer) {
    if (Object.keys(sizingParams).length > 0) {
      sizingContainer.innerHTML = _renderParamsHtml({ ...commonOpts, tunableParams: sizingParams });
      sizingContainer.style.display = 'block';
    } else {
      sizingContainer.innerHTML = '<div style="color:var(--text-muted);font-size:0.8rem;padding:0.25rem 0;">No sizing params</div>';
      sizingContainer.style.display = 'block';
    }
  }
}

function toggleBtSellDeps(selectEl) {
  const c = document.getElementById('bt-sell-params');
  const s = document.getElementById('bt-sell-sizing-params');
  if (c) _toggleDeps(c, selectEl.dataset.param, selectEl.value);
  if (s) _toggleDeps(s, selectEl.dataset.param, selectEl.value);
}

// ============================================================
//  Review (Step 5)
// ============================================================
function buildReview() {
  const el = document.getElementById('review-summary');
  if (!el) return;

  const symbol = document.getElementById('bt-symbol').value;
  const usdt = document.getElementById('bt-initial-usdt').value;
  const startD = document.getElementById('bt-start-date').value;
  const endD = document.getElementById('bt-end-date').value;
  const buyLogic = document.getElementById('bt-buy-logic');
  const sellLogic = document.getElementById('bt-sell-logic');
  const sizingMode = document.getElementById('bt-sizing-mode');
  const buyName = buyLogic ? buyLogic.options[buyLogic.selectedIndex]?.text || buyLogic.value : '-';
  const sellName = sellLogic ? sellLogic.options[sellLogic.selectedIndex]?.text || sellLogic.value : '-';
  const sizingText = sizingMode && !sizingMode.disabled ? sizingMode.options[sizingMode.selectedIndex]?.text || sizingMode.value : '-';

  // Collect buy params display
  const buyParams = _collectParamValues('[data-bt-side="buy"]');
  if (sizingMode && !sizingMode.disabled) buyParams.sizing_mode = sizingMode.value;
  const sellParams = _collectParamValues('[data-bt-side="sell"]');

  const renderParams = (params) => Object.entries(params).map(([k, v]) =>
    `<div class="review-item"><span class="label">${escapeHtml(k)}</span><span class="value">${escapeHtml(String(v))}</span></div>`
  ).join('');

  el.innerHTML = `
    <div class="bt-col">
      <div class="bt-section-title">Settings</div>
      <div class="review-item"><span class="label">Symbol</span><span class="value">${escapeHtml(symbol)}</span></div>
      <div class="review-item"><span class="label">Initial USDT</span><span class="value">$${escapeHtml(usdt)}</span></div>
      <div class="review-item"><span class="label">Period</span><span class="value">${escapeHtml(startD || '-')} ~ ${escapeHtml(endD || '-')}</span></div>
    </div>
    <div class="bt-col bt-col-sizing">
      <div class="bt-section-title">Strategy</div>
      <div class="review-item"><span class="label">Buy Logic</span><span class="value">${escapeHtml(buyName)}</span></div>
      <div class="review-item"><span class="label">Sizing Mode</span><span class="value">${escapeHtml(sizingText)}</span></div>
      <div class="review-item"><span class="label">Sell Logic</span><span class="value">${escapeHtml(sellName)}</span></div>
      ${Object.keys(buyParams).length ? `<div style="margin-top:0.5rem;border-top:1px solid var(--border);padding-top:0.25rem;">
        <button class="review-params-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
          Buy Params (${Object.keys(buyParams).length})
        </button>
        <div class="review-params-body">${renderParams(buyParams)}</div>
      </div>` : ''}
      ${Object.keys(sellParams).length ? `<div style="margin-top:0.25rem;border-top:1px solid var(--border);padding-top:0.25rem;">
        <button class="review-params-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
          Sell Params (${Object.keys(sellParams).length})
        </button>
        <div class="review-params-body">${renderParams(sellParams)}</div>
      </div>` : ''}
    </div>
  `;
}

// ============================================================
//  Collect & Run
// ============================================================
function _collectConfig() {
  const buyEl = document.getElementById('bt-buy-logic');
  const sellEl = document.getElementById('bt-sell-logic');
  const sizingEl = document.getElementById('bt-sizing-mode');
  if (!buyEl || !sellEl) return null;

  const buyParams = _collectParamValues('[data-bt-side="buy"]');
  // Include sizing_mode from standalone dropdown
  if (sizingEl && !sizingEl.disabled) buyParams.sizing_mode = sizingEl.value;

  return {
    name: 'backtest',
    buy_logic_name: buyEl.value,
    buy_params: buyParams,
    sell_logic_name: sellEl.value,
    sell_params: _collectParamValues('[data-bt-side="sell"]'),
  };
}

async function startBacktest() {
  const symbol = document.getElementById('bt-symbol').value;
  const initialUsdt = parseFloat(document.getElementById('bt-initial-usdt').value) || 10000;
  const startDate = document.getElementById('bt-start-date').value;
  const endDate = document.getElementById('bt-end-date').value;

  if (!startDate || !endDate) { showToast('Please select start and end dates', 'error'); return; }

  const startTsMs = new Date(startDate).getTime();
  const endTsMs = new Date(endDate + 'T23:59:59').getTime();
  if (startTsMs >= endTsMs) { showToast('Start date must be before end date', 'error'); return; }

  const config = _collectConfig();
  if (!config) { showToast('Select buy and sell logics', 'error'); return; }

  const btn = document.getElementById('bt-run-btn');
  btn.disabled = true;
  btn.textContent = 'Starting...';

  try {
    const resp = await apiFetch('/api/backtest/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
      body: JSON.stringify({ symbol, start_ts_ms: startTsMs, end_ts_ms: endTsMs, initial_usdt: initialUsdt, combos: [config] }),
    });
    if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.detail || 'Failed to start backtest'); }
    const data = await resp.json();
    showToast('Backtest started', 'success');
    _startBacktestPolling(data.id);
    loadBacktestHistory();
  } catch (e) {
    showToast('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Run Backtest';
  }
}

// ============================================================
//  Polling & History
// ============================================================
function _startBacktestPolling(runId) {
  if (_backtestPollTimer) clearInterval(_backtestPollTimer);
  _backtestPollTimer = setInterval(async () => {
    try {
      const resp = await apiFetch('/api/backtest/' + runId + '/status');
      if (!resp.ok) return;
      const data = await resp.json();
      if (data.status === 'COMPLETED' || data.status === 'FAILED') {
        clearInterval(_backtestPollTimer);
        _backtestPollTimer = null;
        loadBacktestHistory();
        showToast(data.status === 'COMPLETED' ? 'Backtest completed!' : 'Backtest failed: ' + (data.error_message || 'Unknown error'),
          data.status === 'COMPLETED' ? 'success' : 'error');
      }
    } catch (e) {}
  }, 2000);
}

function filterHistory(filter, btn) {
  _historyFilter = filter;
  document.querySelectorAll('#bt-history-filter .tf-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderHistory();
}

function renderHistory() {
  const tbody = document.getElementById('backtest-history-tbody');
  if (!tbody) return;
  let runs = _historyData;
  if (_historyFilter === 'pinned') runs = runs.filter(r => r.pinned);

  if (!runs.length) {
    tbody.innerHTML = `<tr><td colspan="7" class="table-empty">${_historyFilter === 'pinned' ? 'No pinned reports' : 'No backtests yet'}</td></tr>`;
    return;
  }

  tbody.innerHTML = runs.map(r => {
    const created = new Date(r.created_at).toLocaleString();
    const startD = new Date(r.start_ts_ms).toLocaleDateString();
    const endD = new Date(r.end_ts_ms).toLocaleDateString();
    const strats = r.combos ? r.combos.map(c => `${c.buy_logic_name} + ${c.sell_logic_name}`).join(', ') : '-';
    const pnlClass = r.pnl_pct != null ? (r.pnl_pct >= 0 ? 'pnl-positive' : 'pnl-negative') : '';
    const pnlText = r.pnl_pct != null ? r.pnl_pct.toFixed(2) + '%' : '-';
    const pinnedBadge = r.pinned ? '<span class="badge-pinned">Pinned</span>' : '';
    let statusBadge = '';
    if (r.status === 'COMPLETED') statusBadge = '<span class="status-badge badge-success">Completed</span>';
    else if (r.status === 'RUNNING') statusBadge = '<span class="status-badge badge-warning">Running</span>';
    else if (r.status === 'PENDING') statusBadge = '<span class="status-badge badge-neutral">Pending</span>';
    else statusBadge = '<span class="status-badge badge-danger">Failed</span>';
    let actions = '';
    if (r.status === 'COMPLETED') actions = `<a href="/admin/backtest/${r.id}" class="btn btn-outline btn-sm">View</a>`;
    if (r.status !== 'RUNNING' && r.status !== 'PENDING') actions += ` <button class="btn btn-outline btn-sm" style="color:var(--danger);border-color:var(--danger);" onclick="deleteBacktest('${r.id}')">Delete</button>`;
    return `<tr>
      <td style="font-size:0.8rem;">${escapeHtml(created)}</td>
      <td>${escapeHtml(r.symbol)}</td>
      <td style="font-size:0.85rem;">${escapeHtml(strats)}</td>
      <td style="font-size:0.85rem;">${escapeHtml(startD)} ~ ${escapeHtml(endD)}</td>
      <td class="${pnlClass}">${pnlText}</td>
      <td>${statusBadge}${pinnedBadge}</td>
      <td><div class="actions-cell">${actions}</div></td>
    </tr>`;
  }).join('');
}

async function loadBacktestHistory() {
  const tbody = document.getElementById('backtest-history-tbody');
  if (!tbody) return;
  try {
    const resp = await apiFetch('/api/backtest/list');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    _historyData = await resp.json();
    renderHistory();

    const hasActive = _historyData.some(r => r.status === 'RUNNING' || r.status === 'PENDING');
    if (hasActive && !_backtestPollTimer) {
      const activeRun = _historyData.find(r => r.status === 'RUNNING' || r.status === 'PENDING');
      if (activeRun) _startBacktestPolling(activeRun.id);
    }
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="7" class="table-empty error-text">Failed to load history</td></tr>';
  }
}

async function deleteBacktest(runId) {
  if (!confirm('Delete this backtest?')) return;
  try {
    const resp = await apiFetch('/api/backtest/' + runId, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': getCsrfToken() },
    });
    if (resp.ok) { showToast('Deleted', 'success'); loadBacktestHistory(); }
    else { const err = await resp.json().catch(() => ({})); showToast('Error: ' + (err.detail || 'Delete failed'), 'error'); }
  } catch (e) { showToast('Network error: ' + e.message, 'error'); }
}

// ============================================================
//  Init
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  document.getElementById('bt-end-date').value = now.toISOString().split('T')[0];
  document.getElementById('bt-start-date').value = weekAgo.toISOString().split('T')[0];
  loadBtLogics();
  loadBacktestHistory();
});
</script>
{% endblock %}
